<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Playground</title>
    <link rel="stylesheet" href="chat-navigator.css">
    <link rel="stylesheet" href="chat.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .copy-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #219a52;
        }
        
        .editor-container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        .sidebar {
            width: 300px;
            min-width: 200px;
            background: white;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        
        .center-panel {
            flex: 1;
            min-width: 300px;
            background: #fff;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        
        .preview-panel {
            width: 400px;
            min-width: 250px;
            background: white;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        
        .resize-handle {
            width: 5px;
            background: #bdc3c7;
            cursor: col-resize;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .resize-handle:hover {
            background: #3498db;
        }
        
        .resize-handle:active {
            background: #2980b9;
        }
        
        .resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: rgba(255,255,255,0.8);
            border-radius: 2px;
        }
        
        .element-item {
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: grab;
            transition: all 0.3s;
        }
        
        .element-item:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .element-item:active {
            cursor: grabbing;
        }
        
        .drop-zone {
            min-height: 400px;
            border: 3px dashed #bdc3c7;
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
            transition: all 0.3s;
        }
        
        .drop-zone.drag-over {
            border-color: #3498db;
            background: #ebf3fd;
        }
        
        .dropped-element {
            margin: 15px 0;
            padding: 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            position: relative;
            cursor: grab;
        }
        
        .dropped-element:active {
            cursor: grabbing;
        }
        
        .dropped-element.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        .drop-indicator {
            height: 4px;
            background: #3498db;
            border-radius: 2px;
            margin: 10px 0;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }
        
        .element-drag-over {
            border-color: #e74c3c !important;
            background: #fdf2f2 !important;
        }
        
        .element-controls {
            position: absolute;
            top: -10px;
            right: 10px;
            background: #3498db;
            border-radius: 15px;
            padding: 5px;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 30px 30px 20px 30px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .modal-form-container {
            padding: 20px 30px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .modal-buttons {
            padding: 20px 30px 30px 30px;
            border-top: 1px solid #eee;
            text-align: right;
            flex-shrink: 0;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .formatting-toolbar {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px 5px 0 0;
            padding: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .format-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .format-btn:hover {
            background: #e9ecef;
        }
        
        .format-btn:active {
            background: #dee2e6;
        }
        
        .rich-textarea {
            border-radius: 0 0 4px 4px !important;
            border-top: none !important;
        }
        
        .dynamic-list-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #f9f9f9;
        }
        
        .list-item-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
            gap: 10px;
        }
        
        .list-item-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .remove-item-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-item-btn:hover {
            background: #c0392b;
        }
        
        .add-item-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .add-item-btn:hover {
            background: #219a52;
        }
        
        /* Custom CSS Variables for the document elements */
        :root {
            --nycbs-purple: #6f42c1;
        }
        
        /* EDITOR ONLY STYLES - not for preview */
        .editor-grid {
            display: grid;
        }
        
        .editor-grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .editor-grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .editor-info-card, .editor-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .editor-card-content {
            height: 100%;
        }
        
        .editor-card-title {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .editor-card-text {
            margin: 0;
            line-height: 1.6;
        }
        
        .editor-text-center {
            text-align: center;
        }
        
        .editor-mt-4 {
            margin-top: 1.5rem;
        }
        
        .editor-mb-3 {
            margin-bottom: 1rem;
        }
        
        .editor-section {
            padding: 40px 0;
        }
        
        .editor-section-light {
            background-color: #f8f9fa;
        }
        
        .editor-cta-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .editor-cta-content h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .editor-btn-lg {
            padding: 15px 30px;
            font-size: 18px;
            text-decoration: none;
            display: inline-block;
            border-radius: 6px;
            background: #3498db;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CSS Element Drag & Drop Editor</h1>
        <button class="copy-btn" onclick="copyHTML()">üìã Copy Body Content</button>
        <button class="copy-btn" style="background: #3498db;" onclick="openPasteModal()">üì• Paste Body Content</button>
    </div>
    
    <div class="editor-container">
        <!-- LEFT PANEL - Draggable Elements -->
        <div class="sidebar" id="sidebar">
            <h3 class="section-title">Available Elements</h3>
            
            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" id="elementSearch" placeholder="üîç Search elements..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 15px; font-size: 14px;">
            </div>
            
            <!-- TYPOGRAPHY -->
            <div class="element-category">
                <h4 style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd;">üìù Typography</h4>
                
                <div class="element-item" draggable="true" data-type="heading-1" data-keywords="heading h1 title main large">
                    <h4>üì∞ Heading 1 (H1)</h4>
                    <p>Largest heading style</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="heading-2" data-keywords="heading h2 title section">
                    <h4>üì∞ Heading 2 (H2)</h4>
                    <p>Second level heading</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="heading-3" data-keywords="heading h3 title subsection">
                    <h4>üì∞ Heading 3 (H3)</h4>
                    <p>Third level heading</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="heading-4" data-keywords="heading h4 title minor">
                    <h4>üì∞ Heading 4 (H4)</h4>
                    <p>Fourth level heading</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="paragraph" data-keywords="paragraph text content body copy">
                    <h4>üìù Paragraph</h4>
                    <p>Regular paragraph text</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="space" data-keywords="space spacing break gap vertical whitespace">
                    <h4>‚¨ú Space</h4>
                    <p>Add vertical spacing between elements</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="section-header" data-keywords="section header title heading border">
                    <h4>üìù Section Header</h4>
                    <p>Section title with styling</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="link" data-keywords="link hyperlink anchor url">
                    <h4>üîó Link</h4>
                    <p>Styled hyperlink</p>
                </div>
            </div>
            
            <!-- PAGE STRUCTURE -->
            <div class="element-category">
                <h4 style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd;">üìè Page Structure</h4>
                
                <div class="element-item" draggable="true" data-type="section-light" data-keywords="section background light layout page structure">
                    <h4>üåü Light Background Section</h4>
                    <p>Section with light background</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="cta-section" data-keywords="call to action cta banner button section">
                    <h4>üì¢ Call-to-Action</h4>
                    <p>CTA section with button</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="breadcrumb" data-keywords="navigation breadcrumb menu trail path">
                    <h4>üçû Breadcrumb Navigation</h4>
                    <p>Navigation breadcrumb trail</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="divider" data-keywords="divider line separator hr horizontal">
                    <h4>‚ûñ Divider</h4>
                    <p>Horizontal dividing line</p>
                </div>
            </div>
            
            <!-- BUTTONS -->
            <div class="element-category">
                <h4 style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd;">üîò Buttons</h4>
                
                <div class="element-item" draggable="true" data-type="btn-primary" data-keywords="button primary main cta action">
                    <h4>üîµ Primary Button</h4>
                    <p>Main call-to-action button</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="btn-primary-large" data-keywords="button primary large big main cta">
                    <h4>üîµ Primary Button (Large)</h4>
                    <p>Large primary button</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="btn-primary-small" data-keywords="button primary small mini compact">
                    <h4>üîµ Primary Button (Small)</h4>
                    <p>Small primary button</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="btn-secondary" data-keywords="button secondary alternate grey gray">
                    <h4>‚ö´ Secondary Button</h4>
                    <p>Secondary action button</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="btn-blue" data-keywords="button blue colored theme">
                    <h4>üî∑ Blue Button</h4>
                    <p>Blue themed button</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="btn-white" data-keywords="button white outline border light">
                    <h4>‚ö™ White Button</h4>
                    <p>White button with border</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="btn-full" data-keywords="button full width wide block">
                    <h4>üìè Full Width Button</h4>
                    <p>Button spanning full width</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="btn-icon" data-keywords="button icon circular round symbol">
                    <h4>üéØ Icon Button</h4>
                    <p>Circular icon-only button</p>
                </div>
            </div>
            
            <!-- MEDIA & CONTENT -->
            <div class="element-category">
                <h4 style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd;">üé® Media & Content</h4>
                
                <div class="element-item" draggable="true" data-type="image" data-keywords="image photo picture media visual">
                    <h4>üñºÔ∏è Image</h4>
                    <p>Standalone image element</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="single-icon" data-keywords="icon fontawesome symbol graphic">
                    <h4>‚≠ê Individual Icon</h4>
                    <p>Single Font Awesome icon</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="single-card" data-keywords="card info box container content">
                    <h4>üÉè Single Card</h4>
                    <p>Individual info card</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="card-with-image" data-keywords="card image photo header visual">
                    <h4>üñºÔ∏è Card with Image</h4>
                    <p>Card component with image header</p>
                </div>
            </div>
            
            <!-- LAYOUT & GRIDS -->
            <div class="element-category">
                <h4 style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd;">üìä Layout & Grids</h4>
                
                <div class="element-item" draggable="true" data-type="info-grid-2" data-keywords="grid 2 column two layout info cards">
                    <h4>üìä 2-Column Info Grid</h4>
                    <p>Grid layout with 2 info cards</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="info-grid-3" data-keywords="grid 3 column three layout info cards">
                    <h4>üìä 3-Column Info Grid</h4>
                    <p>Grid layout with 3 info cards</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="info-grid-4" data-keywords="grid 4 column four layout demo">
                    <h4>üìä 4-Column Info Grid</h4>
                    <p>Grid layout with 4 columns</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="numbered-steps" data-keywords="steps process numbered circles workflow">
                    <h4>üî¢ Numbered Steps</h4>
                    <p>Process steps with numbered circles</p>
                </div>
            </div>
            
            <!-- FORM ELEMENTS -->
            <div class="element-category">
                <h4 style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd;">üìù Form Elements</h4>
                
                <div class="element-item" draggable="true" data-type="form-text-input" data-keywords="form input text field name">
                    <h4>üìÑ Text Input</h4>
                    <p>Single line text input field</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="form-email-input" data-keywords="form input email field address">
                    <h4>‚úâÔ∏è Email Input</h4>
                    <p>Email address input field</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="form-select" data-keywords="form select dropdown menu options">
                    <h4>üìã Select Dropdown</h4>
                    <p>Dropdown selection menu</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="form-textarea" data-keywords="form textarea message multiline text">
                    <h4>üìù Textarea</h4>
                    <p>Multi-line text input area</p>
                </div>
            </div>
            
            <!-- ADVANCED COMPONENTS -->
            <div class="element-category">
                <h4 style="color: #2c3e50; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd;">‚öôÔ∏è Advanced Components</h4>
                
                <div class="element-item" draggable="true" data-type="intro-section" data-keywords="introduction intro paragraph section content">
                    <h4>üìÑ Introduction Section</h4>
                    <p>Paragraph text with optional links</p>
                </div>
                
                <div class="element-item" draggable="true" data-type="contact-form" data-keywords="contact form email fields layout complete">
                    <h4>üìù Contact Form</h4>
                    <p>Complete contact form layout</p>
                </div>
            </div>
        </div>
        
        <!-- RESIZE HANDLE 1 -->
        <div class="resize-handle" id="leftResizer"></div>
        
        <!-- CENTER PANEL - Drop Zone -->
        <div class="center-panel" id="centerPanel">
            <h3 class="section-title">Editor Canvas</h3>
            <div class="drop-zone" id="dropZone">
                <p style="text-align: center; color: #7f8c8d; font-size: 18px;">
                    Drop elements here to start building your page...
                </p>
            </div>
        </div>
        
        <!-- RESIZE HANDLE 2 -->
        <div class="resize-handle" id="rightResizer"></div>
        
        <!-- RIGHT PANEL - Preview -->
        <div class="preview-panel" id="previewPanel">
            <h3 class="section-title">Live Preview</h3>
            <iframe id="preview" style="width: 100%; height: calc(100% - 60px); border: 1px solid #ddd; border-radius: 8px; background: white;" frameborder="0"></iframe>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="edit-modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Element</h3>
            </div>
            <div class="modal-form-container">
                <form id="editForm">
                    <!-- Dynamic form content will be inserted here -->
                </form>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Paste Modal -->
    <div class="edit-modal" id="pasteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Paste Body Content</h3>
            </div>
            <div class="modal-form-container">
                <div class="form-group">
                    <label>HTML Content:</label>
                    <textarea id="pasteContent" placeholder="Paste your HTML content here..." style="width: 100%; height: 200px; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 14px;"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closePasteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="pasteHTML()">Import Content</button>
            </div>
        </div>
    </div>

    <script>
        let draggedElement = null;
        let currentEditElement = null;
        let elementCounter = 0;

        // Element templates - Updated to remove conflicting inline styles
        const templates = {
            'intro-section': {
                html: `<section class="section">
                    <p>{{content}}</p>
                </section>`,
                fields: {
                    content: { type: 'textarea', label: 'Content', default: 'A Bone Density scan is an imaging test that measures bone density (strength). Bone Density scan results can provide helpful details about your risk for osteoporosis (bone loss) and fractures (bone breaks).' }
                }
            },
            'info-grid-2': {
                html: `<section class="section section-light">
                    <h3>{{title}}</h3>
                    <div class="grid grid-cols-2">
                        <div class="info-card">
                            <h4>{{card1Title}}</h4>
                            <p>{{card1Content}}</p>
                        </div>
                        <div class="info-card">
                            <h4>{{card2Title}}</h4>
                            <p>{{card2Content}}</p>
                        </div>
                    </div>
                </section>`,
                fields: {
                    title: { type: 'text', label: 'Section Title', default: 'Who gets a Bone Density scan?' },
                    card1Title: { type: 'text', label: 'Card 1 Title', default: 'Increased Age' },
                    card1Content: { type: 'textarea', label: 'Card 1 Content', default: 'Many individuals lose bone mass as they get older.' },
                    card2Title: { type: 'text', label: 'Card 2 Title', default: 'Family History' },
                    card2Content: { type: 'textarea', label: 'Card 2 Content', default: 'If one or more family members have had osteoporosis or more than one fracture, you could be at a higher risk for bone loss.' }
                }
            },
            'info-grid-3': {
                html: `<section class="section">
                    <h3>{{title}}</h3>
                    <div class="grid grid-cols-3 mt-4">
                        <div class="card">
                            <div class="card-content">
                                <h4 class="card-title text-center">{{card1Title}}</h4>
                                <p class="card-text">{{card1Content}}</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-content">
                                <h4 class="card-title text-center">{{card2Title}}</h4>
                                <p class="card-text">{{card2Content}}</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-content">
                                <h4 class="card-title text-center">{{card3Title}}</h4>
                                <p class="card-text">{{card3Content}}</p>
                            </div>
                        </div>
                    </div>
                </section>`,
                fields: {
                    title: { type: 'text', label: 'Section Title', default: 'What to Expect During the Bone Density Scan?' },
                    card1Title: { type: 'text', label: 'Card 1 Title', default: 'Positioning' },
                    card1Content: { type: 'textarea', label: 'Card 1 Content', default: 'You will be asked to lie on a special Bone Density x-ray table.' },
                    card2Title: { type: 'text', label: 'Card 2 Title', default: 'Scanning Process' },
                    card2Content: { type: 'textarea', label: 'Card 2 Content', default: 'As the arm of the Bone Density machine passes over the body, it uses two different x-ray beams.' },
                    card3Title: { type: 'text', label: 'Card 3 Title', default: 'Results & Review' },
                    card3Content: { type: 'textarea', label: 'Card 3 Content', default: 'These results are then reviewed and interpreted by a radiologist.' }
                }
            },
            'numbered-steps': {
                html: `<section class="section">
                    <h3>{{title}}</h3>
                    <div class="grid grid-cols-3 mt-4">
                        <div class="card">
                            <div class="card-content">
                                <div class="text-center mb-3">
                                    <div style="background: var(--nycbs-purple); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 20px; font-weight: bold;">1</div>
                                </div>
                                <h4 class="card-title text-center">{{step1Title}}</h4>
                                <p class="card-text">{{step1Content}}</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-content">
                                <div class="text-center mb-3">
                                    <div style="background: var(--nycbs-purple); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 20px; font-weight: bold;">2</div>
                                </div>
                                <h4 class="card-title text-center">{{step2Title}}</h4>
                                <p class="card-text">{{step2Content}}</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-content">
                                <div class="text-center mb-3">
                                    <div style="background: var(--nycbs-purple); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 20px; font-weight: bold;">3</div>
                                </div>
                                <h4 class="card-title text-center">{{step3Title}}</h4>
                                <p class="card-text">{{step3Content}}</p>
                            </div>
                        </div>
                    </div>
                </section>`,
                fields: {
                    title: { type: 'text', label: 'Section Title', default: 'Process Steps' },
                    step1Title: { type: 'text', label: 'Step 1 Title', default: 'Positioning' },
                    step1Content: { type: 'textarea', label: 'Step 1 Content', default: 'You will be positioned correctly on the examination table.' },
                    step2Title: { type: 'text', label: 'Step 2 Title', default: 'Scanning Process' },
                    step2Content: { type: 'textarea', label: 'Step 2 Content', default: 'The scanning process begins with specialized equipment.' },
                    step3Title: { type: 'text', label: 'Step 3 Title', default: 'Results & Review' },
                    step3Content: { type: 'textarea', label: 'Step 3 Content', default: 'Results are reviewed by medical professionals.' }
                }
            },
            'single-card': {
                html: `<div class="card mt-4">
                    <div class="card-content">
                        <h4 class="card-title">{{title}}</h4>
                        <p class="card-text">{{content}}</p>
                    </div>
                </div>`,
                fields: {
                    title: { type: 'text', label: 'Card Title', default: 'Your Overall Health' },
                    content: { type: 'textarea', label: 'Card Content', default: 'Many chronic medical disorders can make your bones more likely to break.' }
                }
            },
            'cta-section': {
                html: `<section class="section section-light">
                    <div class="cta-section">
                        <div class="cta-content text-center">
                            <h3>{{title}}</h3>
                            <p>{{description}}</p>
                            <div class="cta-buttons">
                                <a class="btn btn-lg" href="{{link}}" target="{{target}}">{{buttonText}}</a>
                            </div>
                        </div>
                    </div>
                </section>`,
                fields: {
                    title: { type: 'text', label: 'CTA Title', default: 'Schedule Your Bone Density Scan' },
                    description: { type: 'textarea', label: 'Description', default: 'Your healthcare provider is sent a copy of the written report to discuss with you.' },
                    buttonText: { type: 'text', label: 'Button Text', default: 'Call (833) 269-4624' },
                    link: { type: 'text', label: 'Button Link', default: 'tel:8332694624' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'section-header': {
                html: `<h3>{{title}}</h3>`,
                fields: {
                    title: { type: 'text', label: 'Header Text', default: 'Section Title' }
                }
            },
            'btn-primary': {
                html: `<a href="{{url}}" target="{{target}}" class="btn">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Button Text', default: 'Primary Button' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'btn-primary-large': {
                html: `<a href="{{url}}" target="{{target}}" class="btn btn-lg">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Button Text', default: 'Large Primary Button' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'btn-primary-small': {
                html: `<a href="{{url}}" target="{{target}}" class="btn btn-sm">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Button Text', default: 'Small Primary Button' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'btn-secondary': {
                html: `<a href="{{url}}" target="{{target}}" class="btn btn-secondary">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Button Text', default: 'Secondary Button' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'btn-blue': {
                html: `<a href="{{url}}" target="{{target}}" class="btn btn-blue">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Button Text', default: 'Blue Button' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'btn-white': {
                html: `<a href="{{url}}" target="{{target}}" class="btn btn-white">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Button Text', default: 'White Button' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'btn-full': {
                html: `<a href="{{url}}" target="{{target}}" class="btn btn-full">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Button Text', default: 'Full Width Button' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'btn-icon': {
                html: `<a href="{{url}}" target="{{target}}" class="btn btn-icon-only">
                    <i class="fas fa-{{icon}}"></i>
                </a>`,
                fields: {
                    icon: { type: 'text', label: 'Icon Name (Font Awesome)', default: 'plus' },
                    url: { type: 'text', label: 'Button URL', default: '#' },
                    target: { type: 'select', label: 'Open In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'heading-1': {
                html: `<h1>{{text}}</h1>`,
                fields: {
                    text: { type: 'text', label: 'Heading Text', default: 'Main Heading' }
                }
            },
            'heading-2': {
                html: `<h2>{{text}}</h2>`,
                fields: {
                    text: { type: 'text', label: 'Heading Text', default: 'Section Heading' }
                }
            },
            'heading-3': {
                html: `<h3>{{text}}</h3>`,
                fields: {
                    text: { type: 'text', label: 'Heading Text', default: 'Subsection Heading' }
                }
            },
            'heading-4': {
                html: `<h4>{{text}}</h4>`,
                fields: {
                    text: { type: 'text', label: 'Heading Text', default: 'Minor Heading' }
                }
            },
            'paragraph': {
                html: `<p>{{text}}</p>`,
                fields: {
                    text: { type: 'textarea', label: 'Paragraph Text', default: 'This is a paragraph of text. You can write multiple sentences here to create body content for your page.' }
                }
            },
            'space': {
                html: `<div class="spacer" style="height: {{height}}px;"></div>`,
                fields: {
                    height: { type: 'text', label: 'Space Height (pixels)', default: '20' }
                }
            },
            'form-text-input': {
                html: `<div class="form-group">
                    <label class="form-label">{{label}}</label>
                    <input type="text" class="form-input" placeholder="{{placeholder}}" />
                </div>`,
                fields: {
                    label: { type: 'text', label: 'Field Label', default: 'Full Name' },
                    placeholder: { type: 'text', label: 'Placeholder Text', default: 'Enter your name' }
                }
            },
            'form-email-input': {
                html: `<div class="form-group">
                    <label class="form-label">{{label}}</label>
                    <input type="email" class="form-input" placeholder="{{placeholder}}" />
                </div>`,
                fields: {
                    label: { type: 'text', label: 'Field Label', default: 'Email Address' },
                    placeholder: { type: 'text', label: 'Placeholder Text', default: 'Enter your email' }
                }
            },
            'form-select': {
                html: `<div class="form-group">
                    <label class="form-label">{{label}}</label>
                    <select class="form-input">
                        <option>{{option1}}</option>
                        <option>{{option2}}</option>
                        <option>{{option3}}</option>
                        <option>{{option4}}</option>
                    </select>
                </div>`,
                fields: {
                    label: { type: 'text', label: 'Field Label', default: 'Select an Option' },
                    option1: { type: 'text', label: 'Option 1', default: 'Choose...' },
                    option2: { type: 'text', label: 'Option 2', default: 'Option A' },
                    option3: { type: 'text', label: 'Option 3', default: 'Option B' },
                    option4: { type: 'text', label: 'Option 4', default: 'Option C' }
                }
            },
            'form-textarea': {
                html: `<div class="form-group">
                    <label class="form-label">{{label}}</label>
                    <textarea class="form-input form-textarea" placeholder="{{placeholder}}"></textarea>
                </div>`,
                fields: {
                    label: { type: 'text', label: 'Field Label', default: 'Message' },
                    placeholder: { type: 'text', label: 'Placeholder Text', default: 'Enter your message here...' }
                }
            },
            'single-icon': {
                html: `<i class="fas fa-{{icon}}" style="font-size: {{size}}px; color: {{color}};"></i>`,
                fields: {
                    icon: { type: 'text', label: 'Icon Name (Font Awesome)', default: 'star' },
                    size: { type: 'text', label: 'Icon Size (pixels)', default: '24' },
                    color: { type: 'text', label: 'Icon Color', default: '#3498db' }
                }
            },
            'link': {
                html: `<a href="{{url}}">{{text}}</a>`,
                fields: {
                    text: { type: 'text', label: 'Link Text', default: 'Click here for more information' },
                    url: { type: 'text', label: 'Link URL', default: '#' }
                }
            },
            'image': {
                html: `<img src="{{src}}" alt="{{alt}}" style="max-width: 100%; height: auto;" />`,
                fields: {
                    src: { type: 'text', label: 'Image URL', default: 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=300&fit=crop' },
                    alt: { type: 'text', label: 'Alt Text', default: 'Image description' }
                }
            },
            'divider': {
                html: `<hr />`,
                fields: {}
            },
            'card-with-image': {
                html: `<div class="card">
                    <img src="{{imageUrl}}" class="card-image" alt="{{imageAlt}}" />
                    <div class="card-content">
                        <h4 class="card-title">{{title}}</h4>
                        <p class="card-text">{{content}}</p>
                        <a href="{{buttonLink}}" target="{{buttonTarget}}" class="btn btn-sm">{{buttonText}}</a>
                    </div>
                </div>`,
                fields: {
                    title: { type: 'text', label: 'Card Title', default: 'Card with Image' },
                    content: { type: 'textarea', label: 'Card Content', default: 'Cards can include images at the top for more visual impact and context.' },
                    imageUrl: { type: 'text', label: 'Image URL', default: 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=200&fit=crop' },
                    imageAlt: { type: 'text', label: 'Image Alt Text', default: 'Medical equipment' },
                    buttonText: { type: 'text', label: 'Button Text', default: 'View Details' },
                    buttonLink: { type: 'text', label: 'Button Link', default: '#' },
                    buttonTarget: { type: 'select', label: 'Button Opens In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'info-grid-4': {
                html: `<section class="section">
                    <h3>{{title}}</h3>
                    <p>{{description}}</p>
                    <div class="grid grid-cols-4">
                        <div class="demo-column">{{col1}}</div>
                        <div class="demo-column">{{col2}}</div>
                        <div class="demo-column">{{col3}}</div>
                        <div class="demo-column">{{col4}}</div>
                    </div>
                </section>`,
                fields: {
                    title: { type: 'text', label: 'Section Title', default: '4-Column Grid Layout' },
                    description: { type: 'text', label: 'Description', default: 'Flexible grid system for organizing content in columns' },
                    col1: { type: 'text', label: 'Column 1 Content', default: 'Column 1' },
                    col2: { type: 'text', label: 'Column 2 Content', default: 'Column 2' },
                    col3: { type: 'text', label: 'Column 3 Content', default: 'Column 3' },
                    col4: { type: 'text', label: 'Column 4 Content', default: 'Column 4' }
                }
            },
            'contact-form': {
                html: `<section class="section">
                    <h3>{{title}}</h3>
                    <div class="grid grid-cols-2">
                        <div class="card">
                            <div class="card-content">
                                <h4 class="card-title">{{formTitle}}</h4>
                                <div class="form-group">
                                    <label class="form-label">{{nameLabel}}</label>
                                    <input type="text" class="form-input" placeholder="{{namePlaceholder}}" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">{{emailLabel}}</label>
                                    <input type="email" class="form-input" placeholder="{{emailPlaceholder}}" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">{{selectLabel}}</label>
                                    <select class="form-input">
                                        <option>{{selectOption1}}</option>
                                        <option>{{selectOption2}}</option>
                                        <option>{{selectOption3}}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">{{messageLabel}}</label>
                                    <textarea class="form-input form-textarea" placeholder="{{messagePlaceholder}}"></textarea>
                                </div>
                                <button class="btn">{{submitBtn}}</button>
                            </div>
                        </div>
                        <div>
                            <div class="info-card">
                                <i class="fas fa-phone"></i>
                                <h4>{{contactTitle}}</h4>
                                <p>{{contactDescription}}</p>
                                <a href="{{phoneLink}}" target="{{phoneTarget}}" class="btn btn-white">
                                    <i class="fas fa-phone"></i> {{phoneNumber}}
                                </a>
                            </div>
                        </div>
                    </div>
                </section>`,
                fields: {
                    title: { type: 'text', label: 'Section Title', default: 'Contact Us' },
                    formTitle: { type: 'text', label: 'Form Title', default: 'Contact Form Example' },
                    nameLabel: { type: 'text', label: 'Name Field Label', default: 'Full Name' },
                    namePlaceholder: { type: 'text', label: 'Name Placeholder', default: 'Enter your full name' },
                    emailLabel: { type: 'text', label: 'Email Field Label', default: 'Email Address' },
                    emailPlaceholder: { type: 'text', label: 'Email Placeholder', default: 'Enter your email' },
                    selectLabel: { type: 'text', label: 'Select Field Label', default: 'Service Type' },
                    selectOption1: { type: 'text', label: 'Select Option 1', default: 'Select a service...' },
                    selectOption2: { type: 'text', label: 'Select Option 2', default: 'CT Scan' },
                    selectOption3: { type: 'text', label: 'Select Option 3', default: 'Bone Density Scan' },
                    messageLabel: { type: 'text', label: 'Message Field Label', default: 'Message' },
                    messagePlaceholder: { type: 'text', label: 'Message Placeholder', default: 'Tell us how we can help you' },
                    submitBtn: { type: 'text', label: 'Submit Button Text', default: 'Send Message' },
                    contactTitle: { type: 'text', label: 'Contact Info Title', default: 'Contact Information' },
                    contactDescription: { type: 'text', label: 'Contact Description', default: 'Prefer to speak with someone directly? Give us a call!' },
                    phoneNumber: { type: 'text', label: 'Phone Number', default: '(833) 269-4624' },
                    phoneLink: { type: 'text', label: 'Phone Link', default: 'tel:8332694624' },
                    phoneTarget: { type: 'select', label: 'Phone Link Opens In', default: '_self', options: ['_self', '_blank'] }
                }
            },
            'breadcrumb': {
                html: `<nav class="breadcrumb">
                    <a href="{{link1}}">{{text1}}</a>
                    <i class="fas fa-chevron-right"></i>
                    <a href="{{link2}}">{{text2}}</a>
                    <i class="fas fa-chevron-right"></i>
                    <a href="{{link3}}">{{text3}}</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>{{currentPage}}</span>
                </nav>`,
                fields: {
                    text1: { type: 'text', label: 'First Link Text', default: 'Home' },
                    link1: { type: 'text', label: 'First Link URL', default: '#' },
                    text2: { type: 'text', label: 'Second Link Text', default: 'Services' },
                    link2: { type: 'text', label: 'Second Link URL', default: '#' },
                    text3: { type: 'text', label: 'Third Link Text', default: 'Imaging' },
                    link3: { type: 'text', label: 'Third Link URL', default: '#' },
                    currentPage: { type: 'text', label: 'Current Page Text', default: 'Current Page' }
                }
            },
            'section-light': {
                html: `<section class="section section-light">
                    <div class="text-center">
                        <h4>{{title}}</h4>
                        <p>{{content}}</p>
                    </div>
                </section>`,
                fields: {
                    title: { type: 'text', label: 'Section Title', default: 'Light Background Section' },
                    content: { type: 'textarea', label: 'Section Content', default: 'This section uses a light background color for visual variety and content organization.' }
                }
            }
        };

        // Drag and drop functionality
        let draggedCanvasElement = null;

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            
            if (draggedCanvasElement || draggedElement) {
                // Show drop indicators for both reordering and adding new elements
                const indicator = getClosestDropIndicator(e.clientY);
                clearActiveIndicators();
                if (indicator) {
                    indicator.classList.add('active');
                }
                
                // Also add drag-over class to drop zone for visual feedback
                if (e.target.closest('.drop-zone')) {
                    e.target.closest('.drop-zone').classList.add('drag-over');
                }
            }
        });

        document.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('drop-zone')) {
                e.target.classList.remove('drag-over');
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            
            const dropZone = e.target.closest('.drop-zone');
            if (!dropZone) return;
            
            dropZone.classList.remove('drag-over');
            
            if (draggedCanvasElement) {
                // Handle reordering drop
                const indicator = getClosestDropIndicator(e.clientY);
                if (indicator) {
                    dropZone.insertBefore(draggedCanvasElement, indicator);
                    updatePreview();
                }
                clearActiveIndicators();
                draggedCanvasElement.classList.remove('dragging');
                draggedCanvasElement = null;
            } else if (draggedElement) {
                // Handle new element drop with precise placement
                const indicator = getClosestDropIndicator(e.clientY);
                const elementType = draggedElement.dataset.type;
                
                if (indicator) {
                    // Insert before the indicator
                    addElementAtPosition(elementType, indicator);
                } else {
                    // Fallback to append at end
                    addElementToCanvas(elementType);
                }
                
                clearActiveIndicators();
                draggedElement = null;
            }
        });

        function addElementAtPosition(type, beforeIndicator) {
            const template = templates[type];
            if (!template) return;

            elementCounter++;
            const elementId = `element-${elementCounter}`;
            
            // Create default values
            const values = {};
            Object.keys(template.fields).forEach(key => {
                values[key] = template.fields[key].default;
            });

            const elementDiv = document.createElement('div');
            elementDiv.className = 'dropped-element';
            elementDiv.dataset.type = type;
            elementDiv.dataset.id = elementId;
            elementDiv.draggable = true; // Make element draggable for reordering
            
            elementDiv.innerHTML = `
                <div class="element-controls">
                    <button class="control-btn" onclick="editElement('${elementId}')" title="Edit">‚úèÔ∏è</button>
                    <button class="control-btn" onclick="moveUp('${elementId}')" title="Move Up">‚¨ÜÔ∏è</button>
                    <button class="control-btn" onclick="moveDown('${elementId}')" title="Move Down">‚¨áÔ∏è</button>
                    <button class="control-btn" onclick="deleteElement('${elementId}')" title="Delete">üóëÔ∏è</button>
                </div>
                ${renderTemplate(template.html, values)}
            `;

            // Store the values
            elementDiv.dataset.values = JSON.stringify(values);

            const dropZone = document.getElementById('dropZone');
            
            // Remove empty state message if it exists
            const emptyMessage = dropZone.querySelector('p[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            // Insert before the indicator
            dropZone.insertBefore(elementDiv, beforeIndicator);
            
            // Rebuild all drop indicators to ensure proper positioning
            rebuildDropIndicators();
            
            updatePreview();
        }

        function pasteHTML() {
            const htmlContent = document.getElementById('pasteContent').value.trim();
            
            if (!htmlContent) {
                alert('Please paste some HTML content first.');
                return;
            }

            if (confirm('This will clear the current editor content and import the pasted HTML. Continue?')) {
                // Clear current content
                const dropZone = document.getElementById('dropZone');
                dropZone.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 18px;">Drop elements here to start building your page...</p>';
                
                // Parse and import HTML
                parseHTMLToElements(htmlContent);
                
                // Rebuild drop indicators after all elements are added
                rebuildDropIndicators();
                
                // Update preview
                updatePreview();
                
                closePasteModal();
                alert('HTML content imported successfully!');
            }
        }

        function deleteElement(elementId) {
            if (confirm('Are you sure you want to delete this element?')) {
                const element = document.querySelector(`[data-id="${elementId}"]`);
                element.remove();
                
                // Check if dropzone is empty and add empty message
                const dropZone = document.getElementById('dropZone');
                const hasElements = dropZone.querySelector('.dropped-element');
                if (!hasElements) {
                    dropZone.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 18px;">Drop elements here to start building your page...</p>';
                } else {
                    // Rebuild drop indicators
                    rebuildDropIndicators();
                }
                
                updatePreview();
            }
        }

        function moveUp(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            const previous = element.previousElementSibling;
            
            // Skip over drop indicators to find the actual previous element
            let prevElement = previous;
            while (prevElement && prevElement.classList.contains('drop-indicator')) {
                prevElement = prevElement.previousElementSibling;
            }
            
            if (prevElement && prevElement.classList.contains('dropped-element')) {
                element.parentNode.insertBefore(element, prevElement);
                rebuildDropIndicators();
                updatePreview();
            }
        }

        function moveDown(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            const next = element.nextElementSibling;
            
            // Skip over drop indicators to find the actual next element
            let nextElement = next;
            while (nextElement && nextElement.classList.contains('drop-indicator')) {
                nextElement = nextElement.nextElementSibling;
            }
            
            if (nextElement && nextElement.classList.contains('dropped-element')) {
                element.parentNode.insertBefore(nextElement, element);
                rebuildDropIndicators();
                updatePreview();
            }
        }

        function getClosestDropIndicator(y) {
            const dropZone = document.getElementById('dropZone');
            const indicators = [...dropZone.querySelectorAll('.drop-indicator')];
            
            if (indicators.length === 0) return null;
            
            return indicators.reduce((closest, indicator) => {
                const box = indicator.getBoundingClientRect();
                const offset = Math.abs(y - box.top - box.height / 2);
                
                if (offset < closest.offset) {
                    return { offset: offset, element: indicator };
                } else {
                    return closest;
                }
            }, { offset: Number.POSITIVE_INFINITY }).element;
        }

        function clearActiveIndicators() {
            const indicators = document.querySelectorAll('.drop-indicator');
            indicators.forEach(indicator => indicator.classList.remove('active'));
        }

        function addElementToCanvas(type) {
            const template = templates[type];
            if (!template) return;

            elementCounter++;
            const elementId = `element-${elementCounter}`;
            
            // Create default values
            const values = {};
            Object.keys(template.fields).forEach(key => {
                values[key] = template.fields[key].default;
            });

            const elementDiv = document.createElement('div');
            elementDiv.className = 'dropped-element';
            elementDiv.dataset.type = type;
            elementDiv.dataset.id = elementId;
            elementDiv.draggable = true; // Make element draggable for reordering
            
            elementDiv.innerHTML = `
                <div class="element-controls">
                    <button class="control-btn" onclick="editElement('${elementId}')" title="Edit">‚úèÔ∏è</button>
                    <button class="control-btn" onclick="moveUp('${elementId}')" title="Move Up">‚¨ÜÔ∏è</button>
                    <button class="control-btn" onclick="moveDown('${elementId}')" title="Move Down">‚¨áÔ∏è</button>
                    <button class="control-btn" onclick="deleteElement('${elementId}')" title="Delete">üóëÔ∏è</button>
                </div>
                ${renderTemplate(template.html, values)}
            `;

            // Store the values
            elementDiv.dataset.values = JSON.stringify(values);

            const dropZone = document.getElementById('dropZone');
            
            // Remove empty state message if it exists
            const emptyMessage = dropZone.querySelector('p[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            dropZone.appendChild(elementDiv);
            
            // Rebuild all drop indicators
            rebuildDropIndicators();
            
            updatePreview();
        }

        function rebuildDropIndicators() {
            const dropZone = document.getElementById('dropZone');
            const elements = dropZone.querySelectorAll('.dropped-element');
            
            // Remove all existing indicators
            const existingIndicators = dropZone.querySelectorAll('.drop-indicator');
            existingIndicators.forEach(indicator => indicator.remove());
            
            // Add indicator at the very beginning (before first element)
            const firstIndicator = document.createElement('div');
            firstIndicator.className = 'drop-indicator';
            if (elements.length > 0) {
                dropZone.insertBefore(firstIndicator, elements[0]);
            } else {
                dropZone.appendChild(firstIndicator);
            }
            
            // Add indicators after each element
            elements.forEach(element => {
                const indicator = document.createElement('div');
                indicator.className = 'drop-indicator';
                element.parentNode.insertBefore(indicator, element.nextSibling);
            });
        }

        function addParsedElement(type, values) {
            const template = templates[type];
            if (!template) return;

            elementCounter++;
            const elementId = `element-${elementCounter}`;

            const elementDiv = document.createElement('div');
            elementDiv.className = 'dropped-element';
            elementDiv.dataset.type = type;
            elementDiv.dataset.id = elementId;
            elementDiv.draggable = true; // Make element draggable for reordering
            
            elementDiv.innerHTML = `
                <div class="element-controls">
                    <button class="control-btn" onclick="editElement('${elementId}')" title="Edit">‚úèÔ∏è</button>
                    <button class="control-btn" onclick="moveUp('${elementId}')" title="Move Up">‚¨ÜÔ∏è</button>
                    <button class="control-btn" onclick="moveDown('${elementId}')" title="Move Down">‚¨áÔ∏è</button>
                    <button class="control-btn" onclick="deleteElement('${elementId}')" title="Delete">üóëÔ∏è</button>
                </div>
                ${renderTemplate(template.html, values)}
            `;

            // Store the values
            elementDiv.dataset.values = JSON.stringify(values);

            const dropZone = document.getElementById('dropZone');
            
            // Remove empty state message if it exists
            const emptyMessage = dropZone.querySelector('p[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            dropZone.appendChild(elementDiv);
            
            // Don't rebuild indicators here - will be done once after all elements are added
        }

        function addGenericHTMLElement(htmlContent) {
            // Create a generic element template for unmatched HTML
            elementCounter++;
            const elementId = `element-${elementCounter}`;

            const elementDiv = document.createElement('div');
            elementDiv.className = 'dropped-element';
            elementDiv.dataset.type = 'generic-html';
            elementDiv.dataset.id = elementId;
            elementDiv.draggable = true; // Make element draggable for reordering
            
            elementDiv.innerHTML = `
                <div class="element-controls">
                    <button class="control-btn" onclick="editGenericHTML('${elementId}')" title="Edit HTML">‚úèÔ∏è</button>
                    <button class="control-btn" onclick="moveUp('${elementId}')" title="Move Up">‚¨ÜÔ∏è</button>
                    <button class="control-btn" onclick="moveDown('${elementId}')" title="Move Down">‚¨áÔ∏è</button>
                    <button class="control-btn" onclick="deleteElement('${elementId}')" title="Delete">üóëÔ∏è</button>
                </div>
                ${htmlContent}
            `;

            // Store the HTML content
            elementDiv.dataset.values = JSON.stringify({ html: htmlContent });

            const dropZone = document.getElementById('dropZone');
            
            // Remove empty state message if it exists
            const emptyMessage = dropZone.querySelector('p[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            dropZone.appendChild(elementDiv);
            
            // Don't rebuild indicators here - will be done once after all elements are added
        }

        function renderTemplate(html, values) {
            let rendered = html;
            Object.keys(values).forEach(key => {
                const regex = new RegExp(`{{${key}}}`, 'g');
                rendered = rendered.replace(regex, values[key]);
            });
            return rendered;
        }

        function editElement(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            if (!element) return;

            const type = element.dataset.type;
            const template = templates[type];
            const values = JSON.parse(element.dataset.values);

            currentEditElement = element;

            // Generate form
            let formHTML = '';
            Object.keys(template.fields).forEach(key => {
                const field = template.fields[key];
                const value = values[key] || field.default;
                
                if (field.type === 'textarea') {
                    // Check if this is a paragraph or text field that should have rich text editing
                    const isRichText = (type === 'paragraph' && key === 'text') || 
                                     (key === 'content' || key === 'description' || 
                                      key.includes('Content') || key.includes('Description'));
                    
                    if (isRichText) {
                        formHTML += `
                            <div class="form-group">
                                <label>${field.label}</label>
                                <div class="formatting-toolbar">
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'bold')" title="Bold"><strong>B</strong></button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'italic')" title="Italic"><em>I</em></button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'underline')" title="Underline"><u>U</u></button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'linebreak')" title="Line Break">BR</button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'link')" title="Add Link">üîó</button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'unordered-list')" title="Bullet List">‚Ä¢ List</button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'ordered-list')" title="Numbered List">1. List</button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'small')" title="Small Text">small</button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'mark')" title="Highlight">‚ú®</button>
                                    <button type="button" class="format-btn" onclick="formatText('${key}', 'code')" title="Code">&lt;/&gt;</button>
                                </div>
                                <textarea name="${key}" id="textarea-${key}" class="rich-textarea">${value}</textarea>
                            </div>
                        `;
                    } else {
                        formHTML += `
                            <div class="form-group">
                                <label>${field.label}</label>
                                <textarea name="${key}">${value}</textarea>
                            </div>
                        `;
                    }
                } else if (field.type === 'select') {
                    formHTML += `
                        <div class="form-group">
                            <label>${field.label}</label>
                            <select name="${key}">
                    `;
                    if (field.options) {
                        field.options.forEach(option => {
                            const selected = option === value ? 'selected' : '';
                            const displayText = option === '_self' ? 'Same Window' : option === '_blank' ? 'New Tab' : option;
                            formHTML += `<option value="${option}" ${selected}>${displayText}</option>`;
                        });
                    }
                    formHTML += `
                            </select>
                        </div>
                    `;
                } else {
                    formHTML += `
                        <div class="form-group">
                            <label>${field.label}</label>
                            <input type="${field.type}" name="${key}" value="${value}">
                        </div>
                    `;
                }
            });

            document.getElementById('editForm').innerHTML = formHTML;
            document.getElementById('editModal').style.display = 'block';
        }

        function formatText(fieldId, formatType) {
            const textarea = document.getElementById(`textarea-${fieldId}`);
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            
            let formattedText = '';
            
            switch (formatType) {
                case 'bold':
                    formattedText = selectedText ? `<strong>${selectedText}</strong>` : '<strong></strong>';
                    break;
                case 'italic':
                    formattedText = selectedText ? `<em>${selectedText}</em>` : '<em></em>';
                    break;
                case 'underline':
                    formattedText = selectedText ? `<u>${selectedText}</u>` : '<u></u>';
                    break;
                case 'linebreak':
                    formattedText = '<br>';
                    break;
                case 'link':
                    const url = prompt('Enter URL:', 'https://');
                    if (url) {
                        formattedText = selectedText ? `<a href="${url}">${selectedText}</a>` : `<a href="${url}">Link text</a>`;
                    } else {
                        return;
                    }
                    break;
                case 'unordered-list':
                    if (selectedText) {
                        const lines = selectedText.split('\n').filter(line => line.trim());
                        const listItems = lines.map(line => `<li>${line.trim()}</li>`).join('');
                        formattedText = `<ul>${listItems}</ul>`;
                    } else {
                        formattedText = '<ul><li>List item 1</li><li>List item 2</li><li>List item 3</li></ul>';
                    }
                    break;
                case 'ordered-list':
                    if (selectedText) {
                        const lines = selectedText.split('\n').filter(line => line.trim());
                        const listItems = lines.map(line => `<li>${line.trim()}</li>`).join('');
                        formattedText = `<ol>${listItems}</ol>`;
                    } else {
                        formattedText = '<ol><li>List item 1</li><li>List item 2</li><li>List item 3</li></ol>';
                    }
                    break;
                case 'small':
                    formattedText = selectedText ? `<small>${selectedText}</small>` : '<small></small>';
                    break;
                case 'mark':
                    formattedText = selectedText ? `<mark>${selectedText}</mark>` : '<mark></mark>';
                    break;
                case 'code':
                    formattedText = selectedText ? `<code>${selectedText}</code>` : '<code></code>';
                    break;
                default:
                    return;
            }
            
            // Update textarea value
            textarea.value = beforeText + formattedText + afterText;
            
            // Set cursor position after the inserted text
            const newCursorPos = formatType === 'linebreak' ? start + formattedText.length : 
                                selectedText ? start + formattedText.length : start + formattedText.length - (formattedText.includes('></') ? formattedText.indexOf('></') + 2 - formattedText.indexOf('<') : 0);
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditElement = null;
        }

        function saveEdit() {
            if (!currentEditElement) return;

            const form = document.getElementById('editForm');
            const formElements = form.querySelectorAll('input, textarea, select');
            const values = {};
            
            formElements.forEach(element => {
                values[element.name] = element.value;
            });

            const type = currentEditElement.dataset.type;
            
            if (type === 'generic-html') {
                // Handle generic HTML editing
                const controlsHTML = currentEditElement.querySelector('.element-controls').outerHTML;
                currentEditElement.innerHTML = controlsHTML + values.html;
                currentEditElement.dataset.values = JSON.stringify(values);
            } else {
                // Handle template-based editing
                const template = templates[type];
                const controlsHTML = currentEditElement.querySelector('.element-controls').outerHTML;
                currentEditElement.innerHTML = controlsHTML + renderTemplate(template.html, values);
                currentEditElement.dataset.values = JSON.stringify(values);
            }
            
            closeEditModal();
            updatePreview();
        }

        function moveUp(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            const previous = element.previousElementSibling;
            if (previous && previous.classList.contains('dropped-element')) {
                element.parentNode.insertBefore(element, previous);
                updatePreview();
            }
        }

        function moveDown(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            const next = element.nextElementSibling;
            if (next) {
                element.parentNode.insertBefore(next, element);
                updatePreview();
            }
        }

        function deleteElement(elementId) {
            if (confirm('Are you sure you want to delete this element?')) {
                const element = document.querySelector(`[data-id="${elementId}"]`);
                element.remove();
                updatePreview();
            }
        }

        // UPDATED PREVIEW FUNCTION - Now uses only your website's CSS
        function updatePreview() {
            const dropZone = document.getElementById('dropZone');
            const elements = dropZone.querySelectorAll('.dropped-element');
            
            let bodyContent = '';
            
            elements.forEach((element, index) => {
                const content = element.innerHTML;
                // Remove controls from preview
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const controls = tempDiv.querySelector('.element-controls');
                if (controls) controls.remove();
                
                bodyContent += tempDiv.innerHTML;
            });
            
            // Create complete HTML document with ONLY your website's CSS files
            const fullHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview</title>
    <!-- Your actual website CSS files -->
    <link rel="stylesheet" href="chat-navigator.css">
    <link rel="stylesheet" href="chat.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Only essential container styles - let your CSS handle the rest */
        body {
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        ${bodyContent || '<p style="text-align: center; color: #7f8c8d;">Preview will appear here...</p>'}
    </div>
</body>
</html>`;

            const iframe = document.getElementById('preview');
            iframe.srcdoc = fullHTML;
        }

        function copyHTML() {
            const dropZone = document.getElementById('dropZone');
            const elements = dropZone.querySelectorAll('.dropped-element');
            
            // Build body content only
            let bodyContent = '';
            
            elements.forEach(element => {
                const content = element.innerHTML;
                // Remove controls from the copied content
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const controls = tempDiv.querySelector('.element-controls');
                if (controls) controls.remove();
                bodyContent += tempDiv.innerHTML;
            });

            // Copy just the body content without any wrapper HTML or CSS
            navigator.clipboard.writeText(bodyContent).then(() => {
                alert('Body content copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = bodyContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Body content copied to clipboard!');
            });
        }

        function openPasteModal() {
            document.getElementById('pasteModal').style.display = 'block';
            document.getElementById('pasteContent').focus();
        }

        function closePasteModal() {
            document.getElementById('pasteModal').style.display = 'none';
            document.getElementById('pasteContent').value = '';
        }

        function pasteHTML() {
            const htmlContent = document.getElementById('pasteContent').value.trim();
            
            if (!htmlContent) {
                alert('Please paste some HTML content first.');
                return;
            }

            if (confirm('This will clear the current editor content and import the pasted HTML. Continue?')) {
                // Clear current content
                const dropZone = document.getElementById('dropZone');
                dropZone.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 18px;">Drop elements here to start building your page...</p>';
                
                // Parse and import HTML
                parseHTMLToElements(htmlContent);
                
                // Add final drop indicator
                addFinalDropIndicator();
                
                // Update preview
                updatePreview();
                
                closePasteModal();
                alert('HTML content imported successfully!');
            }
        }

        function addFinalDropIndicator() {
            const dropZone = document.getElementById('dropZone');
            const emptyMessage = dropZone.querySelector('p[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            dropZone.appendChild(indicator);
        }

        function deleteElement(elementId) {
            if (confirm('Are you sure you want to delete this element?')) {
                const element = document.querySelector(`[data-id="${elementId}"]`);
                
                // Remove the element and its associated drop indicator
                const nextIndicator = element.nextElementSibling;
                if (nextIndicator && nextIndicator.classList.contains('drop-indicator')) {
                    nextIndicator.remove();
                }
                
                element.remove();
                
                // Check if dropzone is empty and add empty message
                const dropZone = document.getElementById('dropZone');
                const hasElements = dropZone.querySelector('.dropped-element');
                if (!hasElements) {
                    dropZone.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 18px;">Drop elements here to start building your page...</p>';
                }
                
                updatePreview();
            }
        }

        function parseHTMLToElements(htmlContent) {
            // Create a temporary container to parse the HTML
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = htmlContent;
            
            // Process each top-level element
            const topLevelElements = tempContainer.children;
            
            for (let element of topLevelElements) {
                const matchedTemplate = matchElementToTemplate(element);
                
                if (matchedTemplate) {
                    // Create element with matched template
                    const { type, values } = matchedTemplate;
                    addParsedElement(type, values);
                } else {
                    // Create a generic HTML element for unmatched content
                    addGenericHTMLElement(element.outerHTML);
                }
            }
        }

        function matchElementToTemplate(element) {
            const tagName = element.tagName.toLowerCase();
            const textContent = element.textContent.trim();
            const innerHTML = element.innerHTML.trim();
            
            // Match headings - use innerHTML to preserve formatting
            if (tagName === 'h1') {
                return { type: 'heading-1', values: { text: innerHTML } };
            }
            if (tagName === 'h2') {
                return { type: 'heading-2', values: { text: innerHTML } };
            }
            if (tagName === 'h3') {
                return { type: 'heading-3', values: { text: innerHTML } };
            }
            if (tagName === 'h4') {
                return { type: 'heading-4', values: { text: innerHTML } };
            }
            
            // Match paragraphs - use innerHTML to preserve formatting
            if (tagName === 'p') {
                return { type: 'paragraph', values: { text: innerHTML } };
            }
            
            // Match buttons/links
            if (tagName === 'a' && element.classList.contains('btn')) {
                const text = innerHTML;
                const url = element.getAttribute('href') || '#';
                const target = element.getAttribute('target') || '_self';
                
                if (element.classList.contains('btn-lg')) {
                    return { type: 'btn-primary-large', values: { text, url, target } };
                }
                if (element.classList.contains('btn-sm')) {
                    return { type: 'btn-primary-small', values: { text, url, target } };
                }
                if (element.classList.contains('btn-secondary')) {
                    return { type: 'btn-secondary', values: { text, url, target } };
                }
                if (element.classList.contains('btn-blue')) {
                    return { type: 'btn-blue', values: { text, url, target } };
                }
                if (element.classList.contains('btn-white')) {
                    return { type: 'btn-white', values: { text, url, target } };
                }
                
                return { type: 'btn-primary', values: { text, url, target } };
            }
            
            // Match images
            if (tagName === 'img') {
                const src = element.getAttribute('src') || 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=300&fit=crop';
                const alt = element.getAttribute('alt') || 'Image description';
                return { type: 'image', values: { src, alt } };
            }
            
            // Match sections
            if (tagName === 'section') {
                const hasLightClass = element.classList.contains('section-light');
                const heading = element.querySelector('h3');
                const paragraph = element.querySelector('p');
                
                // Check if it's a CTA section
                if (element.querySelector('.cta-section')) {
                    const title = heading ? heading.innerHTML : 'Schedule Your Bone Density Scan';
                    const description = paragraph ? paragraph.innerHTML : 'Your healthcare provider is sent a copy of the written report to discuss with you.';
                    const button = element.querySelector('a.btn');
                    const buttonText = button ? button.innerHTML : 'Call (833) 269-4624';
                    const link = button ? button.getAttribute('href') : 'tel:8332694624';
                    const target = button ? button.getAttribute('target') : '_self';
                    
                    return { type: 'cta-section', values: { title, description, buttonText, link, target } };
                }
                
                // Check if it's a grid section
                const grid = element.querySelector('.grid');
                if (grid) {
                    if (grid.classList.contains('grid-cols-2')) {
                        const title = heading ? heading.innerHTML : 'Two Column Section';
                        const cards = element.querySelectorAll('.info-card, .card');
                        const card1Title = cards[0] ? cards[0].querySelector('h4')?.innerHTML || 'Card 1' : 'Card 1';
                        const card1Content = cards[0] ? cards[0].querySelector('p')?.innerHTML || 'Content 1' : 'Content 1';
                        const card2Title = cards[1] ? cards[1].querySelector('h4')?.innerHTML || 'Card 2' : 'Card 2';
                        const card2Content = cards[1] ? cards[1].querySelector('p')?.innerHTML || 'Content 2' : 'Content 2';
                        
                        return { type: 'info-grid-2', values: { title, card1Title, card1Content, card2Title, card2Content } };
                    }
                    
                    if (grid.classList.contains('grid-cols-3')) {
                        const title = heading ? heading.innerHTML : 'Three Column Section';
                        const cards = element.querySelectorAll('.card');
                        
                        // Check if it's numbered steps
                        const hasNumbers = element.querySelector('[style*="border-radius: 50%"]');
                        if (hasNumbers) {
                            const step1Title = cards[0] ? cards[0].querySelector('h4')?.innerHTML || 'Step 1' : 'Step 1';
                            const step1Content = cards[0] ? cards[0].querySelector('p')?.innerHTML || 'Content 1' : 'Content 1';
                            const step2Title = cards[1] ? cards[1].querySelector('h4')?.innerHTML || 'Step 2' : 'Step 2';
                            const step2Content = cards[1] ? cards[1].querySelector('p')?.innerHTML || 'Content 2' : 'Content 2';
                            const step3Title = cards[2] ? cards[2].querySelector('h4')?.innerHTML || 'Step 3' : 'Step 3';
                            const step3Content = cards[2] ? cards[2].querySelector('p')?.innerHTML || 'Content 3' : 'Content 3';
                            
                            return { type: 'numbered-steps', values: { title, step1Title, step1Content, step2Title, step2Content, step3Title, step3Content } };
                        } else {
                            const card1Title = cards[0] ? cards[0].querySelector('h4')?.innerHTML || 'Card 1' : 'Card 1';
                            const card1Content = cards[0] ? cards[0].querySelector('p')?.innerHTML || 'Content 1' : 'Content 1';
                            const card2Title = cards[1] ? cards[1].querySelector('h4')?.innerHTML || 'Card 2' : 'Card 2';
                            const card2Content = cards[1] ? cards[1].querySelector('p')?.innerHTML || 'Content 2' : 'Content 2';
                            const card3Title = cards[2] ? cards[2].querySelector('h4')?.innerHTML || 'Card 3' : 'Card 3';
                            const card3Content = cards[2] ? cards[2].querySelector('p')?.innerHTML || 'Content 3' : 'Content 3';
                            
                            return { type: 'info-grid-3', values: { title, card1Title, card1Content, card2Title, card2Content, card3Title, card3Content } };
                        }
                    }
                }
                
                // Basic section with light background
                if (hasLightClass) {
                    const title = heading ? heading.innerHTML : 'Light Background Section';
                    const content = paragraph ? paragraph.innerHTML : 'This section uses a light background color.';
                    return { type: 'section-light', values: { title, content } };
                }
                
                // Basic intro section
                if (paragraph && !heading) {
                    const content = paragraph.innerHTML;
                    return { type: 'intro-section', values: { content } };
                }
            }
            
            // Match dividers
            if (tagName === 'hr') {
                return { type: 'divider', values: {} };
            }
            
            // Match single cards
            if (element.classList.contains('card') && !element.closest('.grid')) {
                const title = element.querySelector('h4')?.innerHTML || 'Card Title';
                const content = element.querySelector('p')?.innerHTML || 'Card content';
                const img = element.querySelector('img');
                
                if (img) {
                    const imageUrl = img.getAttribute('src') || 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=200&fit=crop';
                    const imageAlt = img.getAttribute('alt') || 'Image';
                    const button = element.querySelector('a.btn');
                    const buttonText = button ? button.innerHTML : 'View Details';
                    const buttonLink = button ? button.getAttribute('href') : '#';
                    const buttonTarget = button ? button.getAttribute('target') : '_self';
                    
                    return { type: 'card-with-image', values: { title, content, imageUrl, imageAlt, buttonText, buttonLink, buttonTarget } };
                } else {
                    return { type: 'single-card', values: { title, content } };
                }
            }
            
            return null; // No match found
        }

        function addParsedElement(type, values) {
            const template = templates[type];
            if (!template) return;

            elementCounter++;
            const elementId = `element-${elementCounter}`;

            const elementDiv = document.createElement('div');
            elementDiv.className = 'dropped-element';
            elementDiv.dataset.type = type;
            elementDiv.dataset.id = elementId;
            
            elementDiv.innerHTML = `
                <div class="element-controls">
                    <button class="control-btn" onclick="editElement('${elementId}')" title="Edit">‚úèÔ∏è</button>
                    <button class="control-btn" onclick="moveUp('${elementId}')" title="Move Up">‚¨ÜÔ∏è</button>
                    <button class="control-btn" onclick="moveDown('${elementId}')" title="Move Down">‚¨áÔ∏è</button>
                    <button class="control-btn" onclick="deleteElement('${elementId}')" title="Delete">üóëÔ∏è</button>
                </div>
                ${renderTemplate(template.html, values)}
            `;

            // Store the values
            elementDiv.dataset.values = JSON.stringify(values);

            const dropZone = document.getElementById('dropZone');
            
            // Remove empty state message if it exists
            const emptyMessage = dropZone.querySelector('p[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            dropZone.appendChild(elementDiv);
        }

        function addGenericHTMLElement(htmlContent) {
            // Create a generic element template for unmatched HTML
            elementCounter++;
            const elementId = `element-${elementCounter}`;

            const elementDiv = document.createElement('div');
            elementDiv.className = 'dropped-element';
            elementDiv.dataset.type = 'generic-html';
            elementDiv.dataset.id = elementId;
            
            elementDiv.innerHTML = `
                <div class="element-controls">
                    <button class="control-btn" onclick="editGenericHTML('${elementId}')" title="Edit HTML">‚úèÔ∏è</button>
                    <button class="control-btn" onclick="moveUp('${elementId}')" title="Move Up">‚¨ÜÔ∏è</button>
                    <button class="control-btn" onclick="moveDown('${elementId}')" title="Move Down">‚¨áÔ∏è</button>
                    <button class="control-btn" onclick="deleteElement('${elementId}')" title="Delete">üóëÔ∏è</button>
                </div>
                ${htmlContent}
            `;

            // Store the HTML content
            elementDiv.dataset.values = JSON.stringify({ html: htmlContent });

            const dropZone = document.getElementById('dropZone');
            
            // Remove empty state message if it exists
            const emptyMessage = dropZone.querySelector('p[style*="text-align: center"]');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            dropZone.appendChild(elementDiv);
        }

        function editGenericHTML(elementId) {
            const element = document.querySelector(`[data-id="${elementId}"]`);
            if (!element) return;

            const values = JSON.parse(element.dataset.values);
            currentEditElement = element;

            const formHTML = `
                <div class="form-group">
                    <label>HTML Content</label>
                    <textarea name="html" style="height: 200px; font-family: monospace;">${values.html}</textarea>
                </div>
            `;

            document.getElementById('editForm').innerHTML = formHTML;
            document.getElementById('editModal').style.display = 'block';
        }

        // Initialize empty state
        updatePreview();
        
        // Initialize with a single drop indicator for empty canvas
        const dropZone = document.getElementById('dropZone');
        if (!dropZone.querySelector('.drop-indicator')) {
            rebuildDropIndicators();
        }

        // Search functionality
        const searchInput = document.getElementById('elementSearch');
        const allElements = document.querySelectorAll('.element-item');
        const allCategories = document.querySelectorAll('.element-category');

        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Show all elements and categories
                allElements.forEach(el => el.style.display = 'block');
                allCategories.forEach(cat => cat.style.display = 'block');
            } else {
                // Hide all categories first
                allCategories.forEach(cat => cat.style.display = 'none');
                
                let hasVisibleElements = false;
                
                allElements.forEach(el => {
                    const title = el.querySelector('h4').textContent.toLowerCase();
                    const description = el.querySelector('p').textContent.toLowerCase();
                    const keywords = el.dataset.keywords ? el.dataset.keywords.toLowerCase() : '';
                    
                    if (title.includes(searchTerm) || description.includes(searchTerm) || keywords.includes(searchTerm)) {
                        el.style.display = 'block';
                        hasVisibleElements = true;
                        // Show the parent category
                        const parentCategory = el.closest('.element-category');
                        if (parentCategory) {
                            parentCategory.style.display = 'block';
                        }
                    } else {
                        el.style.display = 'none';
                    }
                });
                
                // If no elements match, show a "no results" message
                if (!hasVisibleElements) {
                    // You could add a "no results" message here if desired
                }
            }
        });

        // Panel resizing functionality
        let isResizing = false;
        let currentResizer = null;

        // Add event listeners for resize handles
        document.getElementById('leftResizer').addEventListener('mousedown', initResize);
        document.getElementById('rightResizer').addEventListener('mousedown', initResize);

        function initResize(e) {
            isResizing = true;
            currentResizer = e.target;
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        }

        function doResize(e) {
            if (!isResizing) return;

            const container = document.querySelector('.editor-container');
            const containerRect = container.getBoundingClientRect();
            const sidebar = document.getElementById('sidebar');
            const centerPanel = document.getElementById('centerPanel');
            const previewPanel = document.getElementById('previewPanel');

            if (currentResizer.id === 'leftResizer') {
                // Resizing left panel
                const newLeftWidth = e.clientX - containerRect.left;
                const minLeftWidth = 200;
                const maxLeftWidth = containerRect.width - 550; // Leave space for center and right

                if (newLeftWidth >= minLeftWidth && newLeftWidth <= maxLeftWidth) {
                    sidebar.style.width = newLeftWidth + 'px';
                }
            } else if (currentResizer.id === 'rightResizer') {
                // Resizing right panel
                const newRightWidth = containerRect.right - e.clientX;
                const minRightWidth = 250;
                const maxRightWidth = containerRect.width - sidebar.offsetWidth - 350; // Leave space for left and center

                if (newRightWidth >= minRightWidth && newRightWidth <= maxRightWidth) {
                    previewPanel.style.width = newRightWidth + 'px';
                }
            }
        }

        function stopResize() {
            isResizing = false;
            currentResizer = null;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            document.body.style.cursor = 'default';
            document.body.style.userSelect = 'auto';
        }

        // Prevent dragging interference with resizing
        document.addEventListener('dragstart', (e) => {
            if (isResizing) {
                e.preventDefault();
                return false;
            }
            
            if (e.target.classList.contains('element-item')) {
                // Dragging from sidebar to add new element
                draggedElement = e.target;
                draggedCanvasElement = null;
                e.dataTransfer.effectAllowed = 'copy';
            } else if (e.target.classList.contains('dropped-element')) {
                // Dragging canvas element for reordering
                draggedCanvasElement = e.target;
                draggedElement = null;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
        });

        document.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('dropped-element')) {
                e.target.classList.remove('dragging');
                clearActiveIndicators();
            }
        });

        // Add beforeunload event to prevent accidental page leaving
        window.addEventListener('beforeunload', function(e) {
            // Check if there are any elements in the editor
            const dropZone = document.getElementById('dropZone');
            const hasElements = dropZone.querySelector('.dropped-element');
            
            if (hasElements) {
                e.preventDefault();
                e.returnValue = ''; // This is required for Chrome
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Provider | New York Cancer & Blood Specialists</title>
    <!-- Include your main site CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Directory-specific styles */
        .directory-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .filter-section {
            margin-bottom: 24px;
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e3a8a;
            text-align: left; /* Ensure left alignment */
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .filter-button {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 8px; /* Changed from 20px to 8px to match locations */
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-button:hover:not(:disabled) {
            background-color: #e5e7eb;
        }
        
        .filter-button.active {
            background-color: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
        }
        
        .filter-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #374151;
            color: #9ca3af;
            border-color: #4b5563;
        }
        
        .search-container {
            margin-bottom: 24px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .results-count {
            margin-bottom: 16px;
            color: #6b7280;
        }
        
        .no-results {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            display: none;
            margin-bottom: 24px;
        }
        
        .no-results-title {
            color: #1e40af;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .no-results-message {
            color: #2563eb;
            margin-bottom: 16px;
        }
        
        .clear-filters-button {
            background-color: #2563eb;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .providers-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        @media (min-width: 768px) {
            .providers-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .providers-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .provider-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .provider-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .card-content {
            padding: 20px;
        }
        
        .provider-header {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .provider-image {
            width: 120px;
            height: 160px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .provider-info {
            flex: 1;
            text-align: left;
        }
        
        .provider-info h3 {
            color: #1e40af;
            font-weight: 700;
            margin-bottom: 2px;
            font-size: 16px;
            line-height: 1.2;
        }
        
        .provider-specialty {
            color: #4b5563;
            margin-bottom: 2px;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .provider-credentials {
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 12px; /* Increased from 6px to 12px */
            line-height: 1.2;
        }
        
        /* Google Reviews styling */
        .provider-reviews {
            margin-top: 4px;
            font-size: 14px;
            line-height: 1;
        }
        
        .stars-row {
            display: flex;
            align-items: center;
        }
        
        .star-rating {
            color: #f59e0b; /* Amber/yellow color for stars */
            margin-right: 2px;
        }
        
        .review-count {
            color: #6b7280;
            font-size: 13px;
            margin-top: 3px;
            display: block;
        }
        
        .info-row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            align-items: flex-start;
        }
        
        .info-icon {
            color: #6b7280;
            flex-shrink: 0;
            margin-top: 3px;
        }
        
        .info-content {
            color: #4b5563;
            font-size: 14px;
        }
        
        .info-label {
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 8px;
            display: block;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }
        
        .tag {
            background-color: #eff6ff;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .location-tag {
            background-color: #f0fdf4;
            color: #166534;
        }
        
        .language-tag {
            background-color: #fff7e6;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        .primary-button {
            flex-grow: 1;
            background-color: #2563eb;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .primary-button:hover {
            background-color: #1d4ed8;
        }
        
        .secondary-button {
            background-color: white;
            color: #2563eb;
            border: 1px solid #2563eb;
            padding: 10px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .secondary-button:hover {
            background-color: #eff6ff;
        }
        
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header placeholder - will be filled by your common.js -->
    <div id="header-placeholder"></div>
    
    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="page-title">Find a Provider</h1>
            <p>Connect with our specialists to receive world-class care close to home.</p>
        </div>
    </section>
    
    <!-- Directory Container -->
    <section class="main-content">
        <div class="container">
            <div class="content-section">
                <div class="directory-container">
                    <!-- Search Box -->
                    <div class="search-container">
                        <input
                            id="search-input"
                            type="text"
                            class="search-input"
                            placeholder="Search by name, specialty, or language..."
                        >
                    </div>
                    
                    <!-- Specialty Filter -->
                    <div class="filter-section">
                        <div class="filter-title">Specialty</div>
                        <div class="filter-buttons" id="specialty-filters">
                            <button class="filter-button active" data-filter="all">All Providers</button>
                            <button class="filter-button" data-filter="Medical Oncology">Medical Oncologists</button>
                            <button class="filter-button" data-filter="Radiation Oncology">Radiation Oncologists</button>
                            <button class="filter-button" data-filter="APP">Advanced Practice Providers</button>
                        </div>
                    </div>
                    
                    <!-- County Filter -->
                    <div class="filter-section">
                        <div class="filter-title">County</div>
                        <div class="filter-buttons" id="county-filters">
                            <button class="filter-button active" data-filter="all">All Counties</button>
                            <!-- County buttons will be dynamically generated -->
                        </div>
                    </div>
                    
                    <!-- Language Filter - NEW -->
                    <div class="filter-section">
                        <div class="filter-title">Language</div>
                        <div class="filter-buttons" id="language-filters">
                            <button class="filter-button active" data-filter="all">All Languages</button>
                            <!-- Language buttons will be dynamically generated -->
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="spinner"></div>
                    </div>
                    
                    <!-- Results Count -->
                    <div id="results-count" class="results-count hidden"></div>
                    
                    <!-- No Results Message -->
                    <div id="no-results" class="no-results">
                        <p class="no-results-title">No providers found matching your criteria.</p>
                        <p class="no-results-message">Try adjusting your filters or search term.</p>
                        <button id="clear-filters-button" class="clear-filters-button">Clear All Filters</button>
                    </div>
                    
                    <!-- Providers Container -->
                    <div id="providers-container" class="providers-container hidden"></div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Help Section -->
    <div class="content-section" style="text-align: center;">
        <div class="container">
            <h2>We're Here To Help</h2>
            <p>If you have questions or would like to schedule a consultation with one of our specialists, please contact us.</p>
            <a href="#" class="cta-button">Request an Appointment</a>
        </div>
    </div>
    
    <!-- Footer placeholder - will be filled by your common.js -->
    <div id="footer-placeholder"></div>

    <!-- Include your common JS file that loads header and footer -->
    <script src="js/common.js"></script>
    
    <!-- Directory JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // State variables
            let allProviders = [];
            let searchQuery = '';
            let activeSpecialtyFilter = 'all';
            let activeCountyFilter = 'all';
            let activeLanguageFilter = 'all'; // New language filter
            let zipToCountyMap = {}; // For ZIP code to county mapping
            let countyDisplayNames = { // Only map the NYC boroughs
                "Kings": "Brooklyn",
                "New York": "Manhattan",
                "Richmond": "Staten Island"
            };
            
            // DOM Elements
            const searchInput = document.getElementById('search-input');
            const specialtyFilters = document.getElementById('specialty-filters');
            const countyFilters = document.getElementById('county-filters');
            const languageFilters = document.getElementById('language-filters'); // New language filters element
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const providersContainer = document.getElementById('providers-container');
            const clearFiltersButton = document.getElementById('clear-filters-button');
            
            // Event Listeners
            searchInput.addEventListener('input', handleSearch);
            clearFiltersButton.addEventListener('click', clearFilters);
            
            // Load ZIP to County mapping
            async function loadZipToCountyMap() {
                try {
                    console.log("Loading ZIP to county mapping from counties.csv");
                    
                    // Fetch the CSV file
                    const response = await fetch('counties.csv');
                    if (!response.ok) {
                        console.warn(`Failed to load counties.csv: ${response.status} ${response.statusText}`);
                        console.warn("Will fall back to address-based county detection");
                        return false;
                    }
                    
                    const csvData = await response.text();
                    
                    // Parse CSV data - using commas as delimiter
                    const lines = csvData.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Find the column indices for zip and county_name
                    const zipIndex = headers.findIndex(h => h.trim().toLowerCase() === 'zip');
                    const countyIndex = headers.findIndex(h => h.trim().toLowerCase() === 'county_name');
                    
                    if (zipIndex === -1 || countyIndex === -1) {
                        console.warn("Could not find required columns in counties.csv");
                        return false;
                    }
                    
                    // Process data rows (skip header)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(',');
                        if (values.length <= Math.max(zipIndex, countyIndex)) continue;
                        
                        const zip = String(values[zipIndex]).trim();
                        const county = values[countyIndex].trim();
                        
                        if (zip && county) {
                            zipToCountyMap[zip] = county;
                        }
                    }
                    
                    console.log(`Loaded ${Object.keys(zipToCountyMap).length} ZIP codes to county mappings`);
                    return true;
                } catch (error) {
                    console.warn("Error loading ZIP to county mapping:", error);
                    return false;
                }
            }
            
            // Populate filters based on provider data
            function populateFilters() {
                populateCountyFilters();
                populateLanguageFilters();
                
                // Add event listeners to specialty filter buttons (single select)
                specialtyFilters.querySelectorAll('.filter-button').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.disabled) return;
                        
                        const filterValue = button.getAttribute('data-filter');
                        
                        // Update active class - only one button should be active
                        specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                        
                        // Update active filter
                        activeSpecialtyFilter = filterValue;
                        
                        // Update results and update disabled state of other filters
                        updateResults();
                        updateCountyFilterAvailability();
                        updateLanguageFilterAvailability();
                    });
                });
            }
            
            // Function to populate county filter buttons from the actual provider data
            function populateCountyFilters() {
                console.log("Populating county filters from provider data");
                
                // Extract unique counties from all providers
                const countiesSet = new Set();
                
                allProviders.forEach(provider => {
                    if (provider.active_locations && provider.active_locations.length > 0) {
                        provider.active_locations.forEach(location => {
                            if (location.address) {
                                const county = getCountyFromAddress(location.address);
                                if (county) {
                                    countiesSet.add(county);
                                }
                            }
                        });
                    }
                });
                
                // Create sorted array of counties for consistent display
                const sortedCounties = Array.from(countiesSet).sort();
                console.log(`Found ${sortedCounties.length} unique counties in provider data:`, sortedCounties);
                
                // Store the "All Counties" button HTML
                const allButtonHTML = '<button class="filter-button active" data-filter="all">All Counties</button>';
                
                // Clear existing buttons
                countyFilters.innerHTML = allButtonHTML;
                
                // Add a button for each county that exists in the provider data
                sortedCounties.forEach(county => {
                    // Only rename Kings, Richmond, and New York counties
                    const displayName = countyDisplayNames[county] || county;
                    
                    const button = document.createElement('button');
                    button.className = 'filter-button';
                    button.setAttribute('data-filter', county);
                    button.textContent = displayName;
                    
                    countyFilters.appendChild(button);
                    console.log(`Added county button: ${county} â†’ ${displayName}`);
                });
                
                // Add event listeners to county filter buttons
                countyFilters.querySelectorAll('.filter-button').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.disabled) return;
                        
                        const filterValue = button.getAttribute('data-filter');
                        
                        // Update active class - only one button should be active
                        countyFilters.querySelectorAll('.filter-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                        
                        // Update active filter
                        activeCountyFilter = filterValue;
                        
                        // Update results and update disabled state of other filters
                        updateResults();
                        updateSpecialtyFilterAvailability();
                        updateLanguageFilterAvailability();
                    });
                });
            }
            
            // Function to populate language filter buttons from the actual provider data
            function populateLanguageFilters() {
                console.log("Populating language filters from provider data");
                
                // Extract unique languages from all providers and split "and" combinations
                const languagesSet = new Set();
                const priorityLanguages = [
                    "English", "Spanish", "Korean", "Mandarin"
                ];
                const otherLanguages = new Set();
                
                allProviders.forEach(provider => {
                    if (provider.languages) {
                        // First, split by commas
                        const commaSplit = provider.languages.split(',');
                        
                        commaSplit.forEach(langGroup => {
                            const trimmed = langGroup.trim();
                            
                            // Check if this contains "and" or similar conjunctions
                            if (/\band\b|\&/i.test(trimmed)) {
                                // Split by "and" or "&"
                                const andSplit = trimmed.split(/\band\b|\&/i);
                                andSplit.forEach(singleLang => {
                                    const cleanLang = singleLang.trim();
                                    if (cleanLang) {
                                        if (priorityLanguages.includes(cleanLang)) {
                                            languagesSet.add(cleanLang);
                                        } else {
                                            otherLanguages.add(cleanLang);
                                        }
                                    }
                                });
                            } else {
                                // It's a single language
                                if (trimmed) {
                                    if (priorityLanguages.includes(trimmed)) {
                                        languagesSet.add(trimmed);
                                    } else {
                                        otherLanguages.add(trimmed);
                                    }
                                }
                            }
                        });
                    }
                });
                
                // Store the "All Languages" button HTML
                const allButtonHTML = '<button class="filter-button active" data-filter="all">All Languages</button>';
                
                // Clear existing buttons
                languageFilters.innerHTML = allButtonHTML;
                
                // Add buttons for priority languages in the specified order
                priorityLanguages.forEach(language => {
                    if (languagesSet.has(language)) {
                        const button = document.createElement('button');
                        button.className = 'filter-button';
                        button.setAttribute('data-filter', language);
                        button.textContent = language;
                        
                        languageFilters.appendChild(button);
                        console.log(`Added priority language button: ${language}`);
                    }
                });
                
                // Add "Other" button if there are other languages
                if (otherLanguages.size > 0) {
                    const otherButton = document.createElement('button');
                    otherButton.className = 'filter-button';
                    otherButton.setAttribute('data-filter', 'other');
                    otherButton.textContent = 'Other';
                    
                    languageFilters.appendChild(otherButton);
                    console.log(`Added "Other" language button containing ${otherLanguages.size} languages`);
                    
                    // Store other languages for filtering
                    window.otherLanguages = Array.from(otherLanguages);
                }
                
                // Add event listeners to language filter buttons
                languageFilters.querySelectorAll('.filter-button').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.disabled) return;
                        
                        const filterValue = button.getAttribute('data-filter');
                        
                        // Update active class - only one button should be active
                        languageFilters.querySelectorAll('.filter-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                        
                        // Update active filter
                        activeLanguageFilter = filterValue;
                        
                        // Update results and update disabled state of other filters
                        updateResults();
                        updateSpecialtyFilterAvailability();
                        updateCountyFilterAvailability();
                    });
                });
            }
            
            // Function for handling search input
            function handleSearch() {
                searchQuery = searchInput.value.toLowerCase();
                updateResults();
                // Update filter availability based on search results
                updateCountyFilterAvailability();
                updateSpecialtyFilterAvailability();
                updateLanguageFilterAvailability();
            }
            
            // Function to clear filters
            function clearFilters() {
                searchInput.value = '';
                searchQuery = '';
                
                // Reset specialty filter
                specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.disabled = false; // Enable all buttons
                });
                specialtyFilters.querySelector('[data-filter="all"]').classList.add('active');
                activeSpecialtyFilter = 'all';
                
                // Reset county filter
                countyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.disabled = false; // Enable all buttons
                });
                countyFilters.querySelector('[data-filter="all"]').classList.add('active');
                activeCountyFilter = 'all';
                
                // Reset language filter
                languageFilters.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.disabled = false; // Enable all buttons
                });
                languageFilters.querySelector('[data-filter="all"]').classList.add('active');
                activeLanguageFilter = 'all';
                
                updateResults();
            }
            
            // Extract ZIP code from address and lookup county
            function getCountyFromAddress(address) {
                if (!address) return null;
                
                // Extract a ZIP code from the address
                const zipMatch = address.match(/\b\d{5}(?:-\d{4})?\b/);
                if (zipMatch) {
                    const zipCode = zipMatch[0].substring(0, 5); // Take first 5 digits
                    const county = zipToCountyMap[zipCode];
                    if (county) {
                        return county;
                    }
                }
                
                // If no ZIP found or ZIP not in map, try to extract from text
                const addressLower = address.toLowerCase();
                
                // Direct city/borough mapping
                if (addressLower.includes('brooklyn')) return 'Kings';
                if (addressLower.includes('manhattan')) return 'New York';
                if (addressLower.includes('staten island')) return 'Richmond';
                if (addressLower.includes('bronx')) return 'Bronx';
                if (addressLower.includes('queens')) return 'Queens';
                
                // County name mapping
                if (addressLower.includes('suffolk')) return 'Suffolk';
                if (addressLower.includes('nassau')) return 'Nassau';
                if (addressLower.includes('westchester')) return 'Westchester';
                if (addressLower.includes('putnam')) return 'Putnam';
                if (addressLower.includes('orange')) return 'Orange';
                
                return null;
            }
            
            // Get provider counties based on their locations
            function getProviderCounties(provider) {
                const counties = new Set();
                
                if (provider.active_locations && provider.active_locations.length > 0) {
                    provider.active_locations.forEach(location => {
                        if (location.address) {
                            const county = getCountyFromAddress(location.address);
                            if (county) counties.add(county);
                        }
                    });
                }
                
                return Array.from(counties);
            }
            
            // Get provider languages as an array and split "and" combinations
            function getProviderLanguages(provider) {
                if (!provider.languages) return [];
                
                const languages = [];
                // First split by commas
                const commaSplit = provider.languages.split(',');
                
                commaSplit.forEach(langGroup => {
                    const trimmed = langGroup.trim();
                    
                    // Check if this contains "and" or similar conjunctions
                    if (/\band\b|\&/i.test(trimmed)) {
                        // Split by "and" or "&"
                        const andSplit = trimmed.split(/\band\b|\&/i);
                        andSplit.forEach(singleLang => {
                            const cleanLang = singleLang.trim();
                            if (cleanLang) languages.push(cleanLang);
                        });
                    } else {
                        // It's a single language
                        if (trimmed) languages.push(trimmed);
                    }
                });
                
                return languages;
            }
            
            function getFilteredResults() {
                return allProviders.filter(provider => {
                    // Filter out providers with zero locations
                    if (!provider.active_locations || provider.active_locations.length === 0) {
                        return false;
                    }
                    
                    // Process for providers - filter for only medical oncologists, radiation oncologists, and APPs
                    const isDesiredProviderType =
                        provider.specialty && (
                            provider.specialty.includes('Medical Oncology') ||
                            provider.specialty.includes('Radiation Oncology') ||
                            provider.specialty.includes('Nurse Practitioner') ||
                            provider.specialty.includes('Physician Assistant')
                        );
                    
                    if (!isDesiredProviderType) return false;
                    
                    // Get provider languages for search
                    const providerLanguages = getProviderLanguages(provider);
                    
                    // Search query matching (now includes languages)
                    const matchesSearch = !searchQuery ||
                        provider.name.toLowerCase().includes(searchQuery) ||
                        (provider.specialty && provider.specialty.toLowerCase().includes(searchQuery)) ||
                        providerLanguages.some(lang => lang.toLowerCase().includes(searchQuery));
                    
                    // Specialty filter
                    let matchesSpecialty = activeSpecialtyFilter === 'all';
                    
                    if (activeSpecialtyFilter === 'Medical Oncology') {
                        matchesSpecialty = provider.specialty && provider.specialty.includes('Medical Oncology');
                    } else if (activeSpecialtyFilter === 'Radiation Oncology') {
                        matchesSpecialty = provider.specialty && provider.specialty.includes('Radiation Oncology');
                    } else if (activeSpecialtyFilter === 'APP') {
                        matchesSpecialty = provider.specialty && (
                            provider.specialty.includes('Nurse Practitioner') ||
                            provider.specialty.includes('Physician Assistant')
                        );
                    }
                    
                    // County filter
                    let matchesCounty = activeCountyFilter === 'all';
                    
                    if (activeCountyFilter !== 'all') {
                        // Get provider counties
                        const providerCounties = getProviderCounties(provider);
                        matchesCounty = providerCounties.includes(activeCountyFilter);
                    }
                    
                    // Language filter
                    let matchesLanguage = activeLanguageFilter === 'all';
                    
                    if (activeLanguageFilter !== 'all' && activeLanguageFilter !== 'other') {
                        // Get provider languages
                        matchesLanguage = providerLanguages.includes(activeLanguageFilter);
                    } else if (activeLanguageFilter === 'other') {
                        // Check if provider has any "other" languages
                        matchesLanguage = providerLanguages.some(lang => window.otherLanguages.includes(lang));
                    }
                    
                    return matchesSearch && matchesSpecialty && matchesCounty && matchesLanguage;
                });
            }
            
            // Update which county filters should be disabled based on specialty and language selection
            function updateCountyFilterAvailability() {
                // Skip if "All Specialties" and "All Languages" are selected
                if (activeSpecialtyFilter === 'all' && activeLanguageFilter === 'all') {
                    countyFilters.querySelectorAll('.filter-button').forEach(btn => {
                        if (btn.getAttribute('data-filter') !== 'all') {
                            btn.disabled = false;
                        }
                    });
                    return;
                }
                
                // For each county filter, check if there are any providers that match
                // the currently selected specialty and language
                countyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    const county = btn.getAttribute('data-filter');
                    
                    // Don't disable the "All Counties" button
                    if (county === 'all') return;
                    
                    // Check if there are any providers with this county and selected specialty/language
                    const hasMatches = allProviders.some(provider => {
                        // Check specialty filter
                        let matchesSpecialty = activeSpecialtyFilter === 'all';
                        if (activeSpecialtyFilter === 'Medical Oncology') {
                            matchesSpecialty = provider.specialty && provider.specialty.includes('Medical Oncology');
                        } else if (activeSpecialtyFilter === 'Radiation Oncology') {
                            matchesSpecialty = provider.specialty && provider.specialty.includes('Radiation Oncology');
                        } else if (activeSpecialtyFilter === 'APP') {
                            matchesSpecialty = provider.specialty && (
                                provider.specialty.includes('Nurse Practitioner') ||
                                provider.specialty.includes('Physician Assistant')
                            );
                        }
                        
                        if (!matchesSpecialty) return false;
                        
                        // Check language filter
                        let matchesLanguage = activeLanguageFilter === 'all';
                        if (activeLanguageFilter !== 'all') {
                            const providerLanguages = getProviderLanguages(provider);
                            matchesLanguage = providerLanguages.includes(activeLanguageFilter);
                        }
                        
                        if (!matchesLanguage) return false;
                        
                        // Check county
                        const providerCounties = getProviderCounties(provider);
                        return providerCounties.includes(county);
                    });
                    
                    // Disable or enable button based on matches
                    btn.disabled = !hasMatches;
                    
                    // If a disabled button is active, deactivate it
                    if (btn.disabled && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        
                        // Activate "All Counties"
                        countyFilters.querySelector('[data-filter="all"]').classList.add('active');
                        activeCountyFilter = 'all';
                        
                        // Need to update results since we changed active filters
                        updateResults();
                    }
                });
            }
            
            // Update which specialty filters should be disabled based on county and language selection
            function updateSpecialtyFilterAvailability() {
                // Skip if "All Counties" and "All Languages" are selected
                if (activeCountyFilter === 'all' && activeLanguageFilter === 'all') {
                    specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                        if (btn.getAttribute('data-filter') !== 'all') {
                            btn.disabled = false;
                        }
                    });
                    return;
                }
                
                // For each specialty filter, check if there are any providers that match
                // the currently selected county and language
                specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    const specialty = btn.getAttribute('data-filter');
                    
                    // Don't disable the "All Specialties" button
                    if (specialty === 'all') return;
                    
                    // Check if there are any providers with this specialty and selected county/language
                    const hasMatches = allProviders.some(provider => {
                        // Check county filter
                        let matchesCounty = activeCountyFilter === 'all';
                        if (activeCountyFilter !== 'all') {
                            const providerCounties = getProviderCounties(provider);
                            matchesCounty = providerCounties.includes(activeCountyFilter);
                        }
                        
                        if (!matchesCounty) return false;
                        
                        // Check language filter
                        let matchesLanguage = activeLanguageFilter === 'all';
                        if (activeLanguageFilter !== 'all') {
                            const providerLanguages = getProviderLanguages(provider);
                            matchesLanguage = providerLanguages.includes(activeLanguageFilter);
                        }
                        
                        if (!matchesLanguage) return false;
                        
                        // Check specialty
                        if (specialty === 'Medical Oncology') {
                            return provider.specialty && provider.specialty.includes('Medical Oncology');
                        } else if (specialty === 'Radiation Oncology') {
                            return provider.specialty && provider.specialty.includes('Radiation Oncology');
                        } else if (specialty === 'APP') {
                            return provider.specialty && (
                                provider.specialty.includes('Nurse Practitioner') ||
                                provider.specialty.includes('Physician Assistant')
                            );
                        }
                        
                        return false;
                    });
                    
                    // Disable or enable button based on matches
                    btn.disabled = !hasMatches;
                    
                    // If a disabled button is active, deactivate it
                    if (btn.disabled && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        
                        // Activate "All Specialties"
                        specialtyFilters.querySelector('[data-filter="all"]').classList.add('active');
                        activeSpecialtyFilter = 'all';
                        
                        // Need to update results since we changed active filters
                        updateResults();
                    }
                });
            }
            
            // Update which language filters should be disabled based on county and specialty selection
            function updateLanguageFilterAvailability() {
                // Skip if "All Counties" and "All Specialties" are selected
                if (activeCountyFilter === 'all' && activeSpecialtyFilter === 'all') {
                    languageFilters.querySelectorAll('.filter-button').forEach(btn => {
                        if (btn.getAttribute('data-filter') !== 'all') {
                            btn.disabled = false;
                        }
                    });
                    return;
                }
                
                // For each language filter, check if there are any providers that match
                // the currently selected county and specialty
                languageFilters.querySelectorAll('.filter-button').forEach(btn => {
                    const language = btn.getAttribute('data-filter');
                    
                    // Don't disable the "All Languages" button
                    if (language === 'all') return;
                    
                    // Check if there are any providers with this language and selected county/specialty
                    const hasMatches = allProviders.some(provider => {
                        // Check county filter
                        let matchesCounty = activeCountyFilter === 'all';
                        if (activeCountyFilter !== 'all') {
                            const providerCounties = getProviderCounties(provider);
                            matchesCounty = providerCounties.includes(activeCountyFilter);
                        }
                        
                        if (!matchesCounty) return false;
                        
                        // Check specialty filter
                        let matchesSpecialty = activeSpecialtyFilter === 'all';
                        if (activeSpecialtyFilter === 'Medical Oncology') {
                            matchesSpecialty = provider.specialty && provider.specialty.includes('Medical Oncology');
                        } else if (activeSpecialtyFilter === 'Radiation Oncology') {
                            matchesSpecialty = provider.specialty && provider.specialty.includes('Radiation Oncology');
                        } else if (activeSpecialtyFilter === 'APP') {
                            matchesSpecialty = provider.specialty && (
                                provider.specialty.includes('Nurse Practitioner') ||
                                provider.specialty.includes('Physician Assistant')
                            );
                        }
                        
                        if (!matchesSpecialty) return false;
                        
                        // Check language
                        const providerLanguages = getProviderLanguages(provider);
                        return providerLanguages.includes(language);
                    });
                    
                    // Disable or enable button based on matches
                    btn.disabled = !hasMatches;
                    
                    // If a disabled button is active, deactivate it
                    if (btn.disabled && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        
                        // Activate "All Languages"
                        languageFilters.querySelector('[data-filter="all"]').classList.add('active');
                        activeLanguageFilter = 'all';
                        
                        // Need to update results since we changed active filters
                        updateResults();
                    }
                });
            }
            
            function updateResults() {
                let filteredResults = getFilteredResults();
                
                // Sort providers - doctors first, then APPs
                filteredResults.sort((a, b) => {
                    const aIsApp = a.specialty && (
                        a.specialty.includes('Nurse Practitioner') ||
                        a.specialty.includes('Physician Assistant')
                    );
                    
                    const bIsApp = b.specialty && (
                        b.specialty.includes('Nurse Practitioner') ||
                        b.specialty.includes('Physician Assistant')
                    );
                    
                    // If one is an APP and the other is not, sort APPs later
                    if (aIsApp && !bIsApp) return 1;
                    if (!aIsApp && bIsApp) return -1;
                    
                    // Otherwise sort alphabetically by name
                    return a.name.localeCompare(b.name);
                });
                
                // Update results count
                resultsCount.textContent = `${filteredResults.length} providers found`;
                resultsCount.classList.remove('hidden');
                
                // Show/hide no results message
                if (filteredResults.length === 0) {
                    noResults.style.display = 'block';
                    providersContainer.classList.add('hidden');
                } else {
                    noResults.style.display = 'none';
                    providersContainer.classList.remove('hidden');
                    renderProviders(filteredResults);
                }
            }
            
            function renderProviders(providers) {
                providersContainer.innerHTML = '';
                
                providers.forEach(provider => {
                    const card = document.createElement('div');
                    card.className = 'provider-card';
                    
                    // Create credential string
                    const credentials = provider.credentials ? provider.credentials.join(', ') : '';
                    
                    // Get provider counties
                    const providerCounties = getProviderCounties(provider);
                    
                    // Create locations HTML
                    let locationsHtml = '';
                    if (providerCounties.length > 0) {
                        locationsHtml = `
                            <div class="info-row">
                                <div class="info-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 5.02944 7.02944 1 12 1C16.9706 1 21 5.02944 21 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="info-content">
                                    <span class="info-label">Practice Locations:</span>
                                    <div class="tag-container">
                        `;
                        
                        // Add county tags with display names
                        providerCounties.forEach(county => {
                            const displayName = countyDisplayNames[county] || county;
                            locationsHtml += `<span class="tag location-tag">${displayName}</span>`;
                        });
                        
                        locationsHtml += `
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Create languages HTML
                    let languagesHtml = '';
                    if (provider.languages) {
                        const languageArray = getProviderLanguages(provider);
                        
                        if (languageArray.length > 0) {
                            languagesHtml = `
                                <div class="info-row">
                                    <div class="info-icon">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <line x1="2" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 2C14.5013 4.73835 15.9228 8.29203 16 12C15.9228 15.708 14.5013 19.2616 12 22C9.49872 19.2616 8.07725 15.708 8 12C8.07725 8.29203 9.49872 4.73835 12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="info-content">
                                        <span class="info-label">Languages:</span>
                                        <div class="tag-container">
                            `;
                            
                            languageArray.forEach(language => {
                                languagesHtml += `<span class="tag language-tag">${language}</span>`;
                            });
                            
                            languagesHtml += `
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    card.innerHTML = `
                        <div class="card-content">
                            <div class="provider-header">
                                <img
                                    src="${provider.img || 'https://via.placeholder.com/120x160'}"
                                    alt="${provider.name}"
                                    class="provider-image"
                                    onerror="this.onerror=null; this.src='https://via.placeholder.com/120x160';"
                                />
                                <div class="provider-info">
                                    <h3>${provider.name}</h3>
                                    <div class="provider-specialty">${provider.specialty || ''}</div>
                                    <div class="provider-credentials">${credentials}</div>
                                    <div class="provider-reviews">
                                        <div class="stars-row">
                                            <span>4.9&nbsp;</span>
                                            <div class="star-rating">â˜…â˜…â˜…â˜…â˜…</div>
                                        </div>
                                        <span class="review-count">(500 reviews)</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${locationsHtml}
                            ${languagesHtml}
                            
                            <div class="action-buttons">
                                <a
                                    href="${provider.link || '#'}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="primary-button"
                                >
                                    View Profile
                                </a>
                            </div>
                        </div>
                    `;
                    
                    providersContainer.appendChild(card);
                });
            }
            
            // Fetch providers data from API
            async function fetchData() {
                try {
                    // First load ZIP to county mapping
                    await loadZipToCountyMap();
                    
                    // Show loading indicator
                    loadingIndicator.style.display = 'flex';
                    
                    // Fetch from real API
                    const response = await fetch('https://api.nycancer.com/open/directory/filter/');
                    if (!response.ok) {
                        throw new Error(`API responded with status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Process providers data
                    allProviders = data.data;
                    
                    // Hide loading indicator and populate filters
                    loadingIndicator.style.display = 'none';
                    populateFilters();
                    updateResults();
                    
                } catch (err) {
                    console.error("Error fetching providers data:", err);
                    loadingIndicator.style.display = 'none';
                    
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-6 text-center';
                    errorDiv.style.marginBottom = '24px';
                    errorDiv.innerHTML = `
                        <div style="color: #ef4444; margin-bottom: 8px; font-size: 18px;">âš ï¸ Unable to load providers data: ${err.message}</div>
                        <p style="margin-bottom: 16px;">Please check your API connection and try again.</p>
                        <button
                            style="background-color: #2563eb; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;"
                            onclick="window.location.reload()"
                        >
                            Try Again
                        </button>
                    `;
                    document.querySelector('.directory-container').appendChild(errorDiv);
                }
            }
            
            // Initialize
            fetchData();
        });
    </script>
</body>
</html>

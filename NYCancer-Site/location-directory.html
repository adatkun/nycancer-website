<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Location | New York Cancer & Blood Specialists</title>
    <!-- Include your main site CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- Include Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>
    <style>
        /* Directory-specific styles */
        .directory-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        #map-container {
            height: 400px;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .filter-section {
            margin-bottom: 24px;
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e3a8a;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .filter-button {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 8px; /* Changed from 20px to 8px to match results cards */
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-button:hover:not(:disabled) {
            background-color: #e5e7eb;
        }
        
        .filter-button.active {
            background-color: #1d4ed8;
            color: white;
            border-color: #1d4ed8;
        }
        
        .filter-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #374151;
            color: #9ca3af;
            border-color: #4b5563;
        }
        
        .search-container {
            margin-bottom: 24px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .results-count {
            margin-bottom: 16px;
            color: #6b7280;
        }
        
        .no-results {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            display: none;
            margin-bottom: 24px;
        }
        
        .no-results-title {
            color: #1e40af;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .no-results-message {
            color: #2563eb;
            margin-bottom: 16px;
        }
        
        .clear-filters-button {
            background-color: #2563eb;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .locations-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        @media (min-width: 768px) {
            .locations-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .location-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .location-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .location-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .card-content {
            padding: 20px;
        }
        
        .location-name {
            color: #1e40af;
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .info-row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .info-icon {
            color: #6b7280;
            flex-shrink: 0;
            margin-top: 3px;
        }
        
        .info-content {
            color: #4b5563;
            font-size: 14px;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }
        
        .tag {
            background-color: #eff6ff;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 16px;
        }
        
        .provider-item {
            display: flex;
            gap: 8px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            text-decoration: none;
            color: inherit;
        }
        
        .provider-item:hover {
            background-color: #f9fafb;
        }
        
        .provider-image {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .provider-info {
            overflow: hidden;
        }
        
        .provider-name {
            color: #1e40af;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .provider-specialty {
            color: #6b7280;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        .primary-button {
            flex-grow: 1;
            background-color: #2563eb;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .primary-button:hover {
            background-color: #1d4ed8;
        }
        
        .secondary-button {
            background-color: white;
            color: #2563eb;
            border: 1px solid #2563eb;
            padding: 10px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .secondary-button:hover {
            background-color: #eff6ff;
        }
        
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header placeholder - will be filled by your common.js -->
    <div id="header-placeholder"></div>
    
    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="page-title">Find a Location</h1>
            <p>Discover our state-of-the-art facilities offering comprehensive cancer care close to home.</p>
        </div>
    </section>
    
    <!-- Directory Container -->
    <section class="main-content">
        <div class="container">
            <div class="content-section">
                <div class="directory-container">
                    <!-- Map Container -->
                    <div id="map-container"></div>
                    
                    <!-- Search Box -->
                    <div class="search-container">
                        <input
                            id="search-input"
                            type="text"
                            class="search-input"
                            placeholder="Search by location name, address, or ZIP code..."
                        >
                    </div>
                    
                    <!-- Specialty Filter -->
                    <div class="filter-section">
                        <div class="filter-title">Specialty</div>
                        <div class="filter-buttons" id="specialty-filters">
                            <button class="filter-button active" data-filter="all">All Specialties</button>
                            <button class="filter-button" data-filter="Medical Oncology">Medical Oncology</button>
                            <button class="filter-button" data-filter="Radiation Oncology">Radiation Oncology</button>
                            <button class="filter-button" data-filter="Breast Care">Breast Care</button>
                        </div>
                    </div>
                    
                    <!-- County Filter -->
                    <div class="filter-section">
                        <div class="filter-title">County</div>
                        <div class="filter-buttons" id="county-filters">
                            <button class="filter-button active" data-filter="all">All Counties</button>
                            <!-- County buttons will be dynamically generated -->
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="loading-indicator">
                        <div class="spinner"></div>
                    </div>
                    
                    <!-- Results Count -->
                    <div id="results-count" class="results-count hidden"></div>
                    
                    <!-- No Results Message -->
                    <div id="no-results" class="no-results">
                        <p class="no-results-title">No locations found matching your criteria.</p>
                        <p class="no-results-message">Try adjusting your filters or search term.</p>
                        <button id="clear-filters-button" class="clear-filters-button">Clear All Filters</button>
                    </div>
                    
                    <!-- Locations Container -->
                    <div id="locations-container" class="locations-container hidden"></div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Help Section -->
    <div class="content-section" style="text-align: center;">
        <div class="container">
            <h2>We're Here To Help</h2>
            <p>If you have questions or would like to schedule a consultation at one of our locations, please contact us.</p>
            <a href="#" class="cta-button">Request an Appointment</a>
        </div>
    </div>
    
    <!-- Footer placeholder - will be filled by your common.js -->
    <div id="footer-placeholder"></div>

    <!-- Include your common JS file that loads header and footer -->
    <script src="js/common.js"></script>
    
    <!-- Directory JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // State variables
            let allLocations = [];
            let combinedLocations = []; // For locations with same address
            let searchQuery = '';
            let activeSpecialtyFilter = 'all'; // Changed back to single select
            let activeCountyFilter = 'all'; // Changed back to single select
            let map = null;
            let markers = [];
            let zipToCountyMap = {}; // For ZIP code to county mapping
            let countyDisplayNames = { // Only map the NYC boroughs
                "Kings": "Brooklyn",
                "New York": "Manhattan",
                "Richmond": "Staten Island"
            };
            
            // The allowed specialties we want to show
            const allowedSpecialties = ["Medical Oncology", "Radiation Oncology", "Breast Care"];
            
            // DOM Elements
            const searchInput = document.getElementById('search-input');
            const specialtyFilters = document.getElementById('specialty-filters');
            const countyFilters = document.getElementById('county-filters');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const locationsContainer = document.getElementById('locations-container');
            const clearFiltersButton = document.getElementById('clear-filters-button');
            
            // Event Listeners
            searchInput.addEventListener('input', handleSearch);
            clearFiltersButton.addEventListener('click', clearFilters);
            
            // Load ZIP to County mapping
            async function loadZipToCountyMap() {
                try {
                    console.log("Loading ZIP to county mapping from counties.csv");
                    
                    // Fetch the CSV file
                    const response = await fetch('counties.csv');
                    if (!response.ok) {
                        throw new Error(`Failed to load counties.csv: ${response.status} ${response.statusText}`);
                    }
                    
                    const csvData = await response.text();
                    
                    // Parse CSV data - using commas as delimiter
                    const lines = csvData.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Find the column indices for zip and county_name
                    const zipIndex = headers.findIndex(h => h.trim().toLowerCase() === 'zip');
                    const countyIndex = headers.findIndex(h => h.trim().toLowerCase() === 'county_name');
                    
                    if (zipIndex === -1 || countyIndex === -1) {
                        console.error("Could not find required columns in counties.csv");
                        return false;
                    }
                    
                    // Process data rows (skip header)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(',');
                        if (values.length <= Math.max(zipIndex, countyIndex)) continue;
                        
                        const zip = String(values[zipIndex]).trim();
                        const county = values[countyIndex].trim();
                        
                        if (zip && county) {
                            zipToCountyMap[zip] = county;
                        }
                    }
                    
                    console.log(`Loaded ${Object.keys(zipToCountyMap).length} ZIP codes to county mappings`);
                    return true;
                } catch (error) {
                    console.error("Error loading ZIP to county mapping:", error);
                    return false;
                }
            }
            
            // Add event listeners to specialty filter buttons (single select)
            specialtyFilters.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    if (button.disabled) return;
                    
                    const filterValue = button.getAttribute('data-filter');
                    
                    // Update active class - only one button should be active
                    specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    
                    // Update active filter
                    activeSpecialtyFilter = filterValue;
                    
                    // Update results and update disabled state of county filters
                    updateResults();
                    updateCountyFilterAvailability();
                });
            });
            
            // Function to populate county filter buttons from the actual location data
            function populateCountyFilters() {
                console.log("Populating county filters from location data");
                
                // Extract unique counties from all locations
                const countiesSet = new Set();
                combinedLocations.forEach(location => {
                    if (location.county) {
                        countiesSet.add(location.county);
                    }
                });
                
                // Create sorted array of counties for consistent display
                const sortedCounties = Array.from(countiesSet).sort();
                console.log(`Found ${sortedCounties.length} unique counties in location data:`, sortedCounties);
                
                const countiesContainer = document.getElementById('county-filters');
                
                // Store the "All Counties" button HTML
                const allButtonHTML = '<button class="filter-button active" data-filter="all">All Counties</button>';
                
                // Clear existing buttons
                countiesContainer.innerHTML = allButtonHTML;
                
                // Add a button for each county that exists in the location data
                sortedCounties.forEach(county => {
                    // Only rename Kings, Richmond, and New York counties
                    const displayName = countyDisplayNames[county] || county;
                    
                    const button = document.createElement('button');
                    button.className = 'filter-button';
                    button.setAttribute('data-filter', county);
                    button.textContent = displayName;
                    
                    countiesContainer.appendChild(button);
                    console.log(`Added county button: ${county} → ${displayName}`);
                });
                
                // Add event listeners to county filter buttons
                countiesContainer.querySelectorAll('.filter-button').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.disabled) return;
                        
                        const filterValue = button.getAttribute('data-filter');
                        
                        // Update active class - only one button should be active
                        countiesContainer.querySelectorAll('.filter-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                        
                        // Update active filter
                        activeCountyFilter = filterValue;
                        
                        // Update results and update disabled state of specialty filters
                        updateResults();
                        updateSpecialtyFilterAvailability();
                    });
                });
            }
            
            // Function for handling search input
            function handleSearch() {
                searchQuery = searchInput.value.toLowerCase();
                updateResults();
                // Update filter availability based on search results
                updateCountyFilterAvailability();
                updateSpecialtyFilterAvailability();
            }
            
            // Function to clear filters
            function clearFilters() {
                searchInput.value = '';
                searchQuery = '';
                
                // Reset specialty filter
                specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.disabled = false; // Enable all buttons
                });
                specialtyFilters.querySelector('[data-filter="all"]').classList.add('active');
                activeSpecialtyFilter = 'all';
                
                // Reset county filter
                countyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.disabled = false; // Enable all buttons
                });
                countyFilters.querySelector('[data-filter="all"]').classList.add('active');
                activeCountyFilter = 'all';
                
                updateResults();
            }
            
            // Extract ZIP code from address and lookup county
            function getCountyFromAddress(address) {
                if (!address) return null;
                
                // Extract a ZIP code from the address
                const zipMatch = address.match(/\b\d{5}(?:-\d{4})?\b/);
                if (zipMatch) {
                    const zipCode = zipMatch[0].substring(0, 5); // Take first 5 digits
                    const county = zipToCountyMap[zipCode];
                    if (county) {
                        return county;
                    }
                }
                
                // If no ZIP found or ZIP not in map, try to extract from text
                const addressLower = address.toLowerCase();
                
                // Direct city/borough mapping
                if (addressLower.includes('brooklyn')) return 'Kings';
                if (addressLower.includes('manhattan')) return 'New York';
                if (addressLower.includes('staten island')) return 'Richmond';
                if (addressLower.includes('bronx')) return 'Bronx';
                if (addressLower.includes('queens')) return 'Queens';
                
                // County name mapping
                if (addressLower.includes('suffolk')) return 'Suffolk';
                if (addressLower.includes('nassau')) return 'Nassau';
                if (addressLower.includes('westchester')) return 'Westchester';
                if (addressLower.includes('putnam')) return 'Putnam';
                if (addressLower.includes('orange')) return 'Orange';
                
                return null;
            }
            
            // Check if a location has any of the allowed specialties
            function hasAllowedSpecialty(location) {
                if (!location.location_types || !Array.isArray(location.location_types) || location.location_types.length === 0) {
                    return false;
                }
                
                return location.location_types.some(type =>
                    allowedSpecialties.some(specialty => type.includes(specialty))
                );
            }
            
            // Combine locations with the same address
            function combineLocations(locations) {
                const addressMap = new Map();
                
                // Group locations by address
                locations.forEach(location => {
                    if (!location.address) return;
                    
                    const address = location.address.trim();
                    
                    // Try to extract county from address using ZIP code
                    if (address) {
                        location.county = getCountyFromAddress(address);
                    }
                    
                    if (addressMap.has(address)) {
                        const existingLocation = addressMap.get(address);
                        
                        // Combine location_types
                        if (location.location_types && location.location_types.length > 0) {
                            if (!existingLocation.location_types) {
                                existingLocation.location_types = [];
                            }
                            
                            location.location_types.forEach(type => {
                                if (!existingLocation.location_types.includes(type)) {
                                    existingLocation.location_types.push(type);
                                }
                            });
                        }
                        
                        // Combine names if different
                        if (existingLocation.name !== location.name) {
                            existingLocation.combined_names = existingLocation.combined_names || [existingLocation.name];
                            if (!existingLocation.combined_names.includes(location.name)) {
                                existingLocation.combined_names.push(location.name);
                            }
                        }
                        
                        // Combine active_providers
                        if (location.active_providers && location.active_providers.length > 0) {
                            if (!existingLocation.active_providers) {
                                existingLocation.active_providers = [];
                            }
                            
                            location.active_providers.forEach(provider => {
                                if (!existingLocation.active_providers.some(p => p.id === provider.id)) {
                                    existingLocation.active_providers.push(provider);
                                }
                            });
                        }
                        
                        // Keep the better image if one exists
                        if (location.img && (!existingLocation.img || existingLocation.img === 'https://nycancer.com/media/')) {
                            existingLocation.img = location.img;
                        }
                        
                        // Ensure county is set
                        if (location.county && !existingLocation.county) {
                            existingLocation.county = location.county;
                        }
                    } else {
                        // Clone the location to avoid modifying the original
                        const locationCopy = {...location};
                        if (location.name) {
                            locationCopy.combined_names = [location.name];
                        }
                        addressMap.set(address, locationCopy);
                    }
                });
                
                // Get combined locations array
                const combinedLocationsList = Array.from(addressMap.values());
                
                // Filter to only include locations with at least one of the allowed specialties
                return combinedLocationsList.filter(location => hasAllowedSpecialty(location));
            }
            
            function getFilteredResults() {
                return combinedLocations.filter(location => {
                    // Search query matching
                    const matchesSearch = !searchQuery ||
                        (location.name && location.name.toLowerCase().includes(searchQuery)) ||
                        (location.combined_names && location.combined_names.some(name => name.toLowerCase().includes(searchQuery))) ||
                        (location.address && location.address.toLowerCase().includes(searchQuery)) ||
                        (location.county && location.county.toLowerCase().includes(searchQuery));
                    
                    // Specialty filter (single selection)
                    let matchesSpecialty = activeSpecialtyFilter === 'all';
                    
                    if (!matchesSpecialty && location.location_types && location.location_types.length > 0) {
                        // Check if any of the location's types match the active specialty filter
                        matchesSpecialty = location.location_types.some(type =>
                            type.includes(activeSpecialtyFilter)
                        );
                    }
                    
                    // County filter (single selection)
                    let matchesCounty = activeCountyFilter === 'all';
                    
                    if (!matchesCounty && location.county) {
                        matchesCounty = location.county === activeCountyFilter;
                    }
                    
                    return matchesSearch && matchesSpecialty && matchesCounty;
                });
            }
            
            // Update which county filters should be disabled based on specialty selection
            function updateCountyFilterAvailability() {
                // Skip if "All Specialties" is selected
                if (activeSpecialtyFilter === 'all') {
                    countyFilters.querySelectorAll('.filter-button').forEach(btn => {
                        if (btn.getAttribute('data-filter') !== 'all') {
                            btn.disabled = false;
                        }
                    });
                    return;
                }
                
                // For each county filter, check if there are any locations that match
                // the currently selected specialty
                countyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    const county = btn.getAttribute('data-filter');
                    
                    // Don't disable the "All Counties" button
                    if (county === 'all') return;
                    
                    // Check if there are any locations with this county and selected specialty
                    const hasMatches = combinedLocations.some(location => {
                        // Skip if location doesn't have this county
                        if (location.county !== county) return false;
                        
                        // Check if any of the location's specialties match the active specialty filter
                        return location.location_types && location.location_types.some(type =>
                            type.includes(activeSpecialtyFilter)
                        );
                    });
                    
                    // Disable or enable button based on matches
                    btn.disabled = !hasMatches;
                    
                    // If a disabled button is active, deactivate it
                    if (btn.disabled && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        
                        // Activate "All Counties"
                        countyFilters.querySelector('[data-filter="all"]').classList.add('active');
                        activeCountyFilter = 'all';
                        
                        // Need to update results since we changed active filters
                        updateResults();
                    }
                });
            }
            
            // Update which specialty filters should be disabled based on county selection
            function updateSpecialtyFilterAvailability() {
                // Skip if "All Counties" is selected
                if (activeCountyFilter === 'all') {
                    specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                        if (btn.getAttribute('data-filter') !== 'all') {
                            btn.disabled = false;
                        }
                    });
                    return;
                }
                
                // For each specialty filter, check if there are any locations that match
                // the currently selected county
                specialtyFilters.querySelectorAll('.filter-button').forEach(btn => {
                    const specialty = btn.getAttribute('data-filter');
                    
                    // Don't disable the "All Specialties" button
                    if (specialty === 'all') return;
                    
                    // Check if there are any locations with this specialty and selected county
                    const hasMatches = combinedLocations.some(location => {
                        // Skip if location doesn't have this specialty
                        if (!location.location_types ||
                            !location.location_types.some(type => type.includes(specialty))) {
                            return false;
                        }
                        
                        // Check if location is in the active county
                        return location.county && location.county === activeCountyFilter;
                    });
                    
                    // Disable or enable button based on matches
                    btn.disabled = !hasMatches;
                    
                    // If a disabled button is active, deactivate it
                    if (btn.disabled && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        
                        // Activate "All Specialties"
                        specialtyFilters.querySelector('[data-filter="all"]').classList.add('active');
                        activeSpecialtyFilter = 'all';
                        
                        // Need to update results since we changed active filters
                        updateResults();
                    }
                });
            }
            
            function updateResults() {
                const filteredResults = getFilteredResults();
                
                // Update results count
                resultsCount.textContent = `${filteredResults.length} locations found`;
                resultsCount.classList.remove('hidden');
                
                // Show/hide no results message
                if (filteredResults.length === 0) {
                    noResults.style.display = 'block';
                    locationsContainer.classList.add('hidden');
                } else {
                    noResults.style.display = 'none';
                    locationsContainer.classList.remove('hidden');
                    renderLocations(filteredResults);
                }
                
                // Update map markers
                updateMapMarkers(filteredResults);
            }
            
            function renderLocations(locations) {
                locationsContainer.innerHTML = '';
                
                locations.forEach(location => {
                    const card = document.createElement('div');
                    card.className = 'location-card';
                    
                    // Determine name to display
                    let displayName = location.name;
                    if (location.combined_names && location.combined_names.length > 1) {
                        displayName = location.combined_names.join(' & ');
                    }
                    
                    // Create specialties HTML
                    let specialtiesHtml = '';
                    if (location.location_types && location.location_types.length > 0) {
                        specialtiesHtml = `
                            <div style="margin-top: 12px;">
                                <h4 style="font-weight: 500; margin-bottom: 4px;">Specialties:</h4>
                                <div class="tag-container">
                        `;
                        
                        location.location_types.forEach(type => {
                            specialtiesHtml += `<span class="tag">${type}</span>`;
                        });
                        
                        specialtiesHtml += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // Create providers HTML
                    let providersHtml = '';
                    if (location.active_providers && location.active_providers.length > 0) {
                        providersHtml = `
                            <div style="margin-top: 16px;">
                                <h4 style="font-weight: 500; margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Providers at this location:
                                </h4>
                                <div class="provider-grid">
                        `;
                        
                        location.active_providers.slice(0, 4).forEach(provider => {
                            providersHtml += `
                                <a
                                    href="${provider.link || '#'}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="provider-item"
                                >
                                    <img
                                        src="${provider.img || 'https://via.placeholder.com/40'}"
                                        alt="${provider.name}"
                                        class="provider-image"
                                        onerror="this.onerror=null; this.src='https://via.placeholder.com/40';"
                                    />
                                    <div class="provider-info">
                                        <div class="provider-name">${provider.name}</div>
                                        <div class="provider-specialty">${provider.speciality || ''}</div>
                                    </div>
                                </a>
                            `;
                        });
                        
                        providersHtml += `
                                </div>
                        `;
                        
                        if (location.active_providers.length > 4) {
                            providersHtml += `
                                <div style="margin-top: 8px; text-align: center;">
                                    <a href="${location.link || '#'}" style="font-size: 14px; color: #2563eb; text-decoration: none;">
                                        See all ${location.active_providers.length} providers
                                    </a>
                                </div>
                            `;
                        }
                        
                        providersHtml += `
                            </div>
                        `;
                    }
                    
                    card.innerHTML = `
                        <img
                            src="${location.img || 'https://via.placeholder.com/400x200'}"
                            alt="${displayName}"
                            class="location-image"
                            onerror="this.onerror=null; this.src='https://via.placeholder.com/400x200';"
                        />
                        <div class="card-content">
                            <div class="location-name">${displayName}</div>
                            
                            <div class="info-row">
                                <div class="info-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 5.02944 7.02944 1 12 1C16.9706 1 21 5.02944 21 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="info-content">${location.address || ''}</div>
                            </div>
                            
                            ${location.internal_phone ? `
                                <div class="info-row">
                                    <div class="info-icon">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M22 16.92V19.92C22.0011 20.1985 21.9441 20.4742 21.8325 20.7293C21.7209 20.9845 21.5573 21.2136 21.3521 21.4019C21.1468 21.5901 20.9046 21.7335 20.6407 21.8227C20.3769 21.9119 20.0974 21.9451 19.82 21.92C16.7428 21.5856 13.787 20.5341 11.19 18.85C8.77382 17.3147 6.72533 15.2662 5.18999 12.85C3.49997 10.2412 2.44824 7.27097 2.11999 4.18C2.095 3.90347 2.12787 3.62476 2.21649 3.36162C2.30512 3.09849 2.44756 2.85669 2.63476 2.65162C2.82196 2.44655 3.0498 2.28271 3.30379 2.17052C3.55777 2.05833 3.83233 2.00026 4.10999 2H7.10999C7.5953 1.99522 8.06579 2.16708 8.43376 2.48353C8.80173 2.79999 9.04207 3.23945 9.10999 3.72C9.23662 4.68007 9.47144 5.62273 9.80999 6.53C9.94454 6.88792 9.97366 7.27691 9.8939 7.65088C9.81415 8.02485 9.62886 8.36811 9.35999 8.64L8.08999 9.91C9.51355 12.4135 11.5864 14.4864 14.09 15.91L15.36 14.64C15.6319 14.3711 15.9751 14.1858 16.3491 14.1061C16.7231 14.0263 17.1121 14.0555 17.47 14.19C18.3773 14.5286 19.3199 14.7634 20.28 14.89C20.7658 14.9585 21.2094 15.2032 21.5265 15.5775C21.8437 15.9518 22.0122 16.4296 22 16.92Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="info-content">${location.internal_phone}</div>
                                </div>
                            ` : ''}
                            
                            ${specialtiesHtml}
                            ${providersHtml}
                            
                            <div class="action-buttons">
                                <a
                                    href="${location.link || '#'}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="primary-button"
                                >
                                    View Location
                                </a>
                                <a
                                    href="https://maps.google.com/?q=${encodeURIComponent(location.address || '')}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="secondary-button"
                                >
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 18L3 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M21 12H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    `;
                    
                    locationsContainer.appendChild(card);
                });
            }
            
            // Add markers to the map
            function addMarkersToMap() {
                // Clear existing markers
                clearMarkers();
                
                // Add markers for all locations
                combinedLocations.forEach(location => {
                    if (location.latitude && location.longitude) {
                        const latLng = {
                            lat: parseFloat(location.latitude),
                            lng: parseFloat(location.longitude)
                        };
                        
                        // Determine name to display
                        let title = location.name;
                        if (location.combined_names && location.combined_names.length > 1) {
                            title = location.combined_names.join(' & ');
                        }
                        
                        const marker = new google.maps.Marker({
                            position: latLng,
                            map: map,
                            title: title
                        });
                        
                        // Add info window with location details
                        const infoContent = `
                            <div style="max-width: 300px; padding: 10px;">
                                <h3 style="margin: 0 0 8px 0; color: #1e40af; font-size: 16px;">${title}</h3>
                                <p style="margin: 0 0 8px 0; font-size: 14px;">${location.address || ''}</p>
                                ${location.internal_phone ? `<p style="margin: 0; font-size: 14px;">Phone: ${location.internal_phone}</p>` : ''}
                                <a href="${location.link || '#'}" style="color: #2563eb; display: block; margin-top: 8px; font-size: 14px; text-decoration: none;" target="_blank">View Details</a>
                            </div>
                        `;
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: infoContent
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
                
                // Adjust map bounds to show all markers
                if (markers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    markers.forEach(marker => bounds.extend(marker.getPosition()));
                    map.fitBounds(bounds);
                    
                    // Zoom out a bit if only one marker
                    if (markers.length === 1) {
                        map.setZoom(13);
                    }
                }
            }
            
            // Update map markers based on filtered results
            function updateMapMarkers(filteredLocations) {
                if (!map) return;
                
                // Clear existing markers
                clearMarkers();
                
                // Add markers for filtered locations
                filteredLocations.forEach(location => {
                    if (location.latitude && location.longitude) {
                        const latLng = {
                            lat: parseFloat(location.latitude),
                            lng: parseFloat(location.longitude)
                        };
                        
                        // Determine name to display
                        let title = location.name;
                        if (location.combined_names && location.combined_names.length > 1) {
                            title = location.combined_names.join(' & ');
                        }
                        
                        const marker = new google.maps.Marker({
                            position: latLng,
                            map: map,
                            title: title
                        });
                        
                        // Add info window with location details
                        const infoContent = `
                            <div style="max-width: 300px; padding: 10px;">
                                <h3 style="margin: 0 0 8px 0; color: #1e40af; font-size: 16px;">${title}</h3>
                                <p style="margin: 0 0 8px 0; font-size: 14px;">${location.address || ''}</p>
                                ${location.internal_phone ? `<p style="margin: 0; font-size: 14px;">Phone: ${location.internal_phone}</p>` : ''}
                                <a href="${location.link || '#'}" style="color: #2563eb; display: block; margin-top: 8px; font-size: 14px; text-decoration: none;" target="_blank">View Details</a>
                            </div>
                        `;
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: infoContent
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        markers.push(marker);
                    }
                });
                
                // Adjust map bounds to show all markers
                if (markers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    markers.forEach(marker => bounds.extend(marker.getPosition()));
                    map.fitBounds(bounds);
                    
                    // Zoom out a bit if only one marker
                    if (markers.length === 1) {
                        map.setZoom(13);
                    }
                } else {
                    // Reset to default view if no markers
                    map.setCenter({ lat: 40.7128, lng: -73.8067 }); // New York
                    map.setZoom(9);
                }
            }
            
            // Clear all markers from the map
            function clearMarkers() {
                markers.forEach(marker => marker.setMap(null));
                markers = [];
            }
            
            // Initialize Google Map
            window.initMap = function() {
                // Create a map centered on New York
                map = new google.maps.Map(document.getElementById('map-container'), {
                    center: { lat: 40.7128, lng: -73.8067 }, // New York
                    zoom: 9
                });
                
                // If locations data is already loaded, add markers
                if (combinedLocations.length > 0) {
                    addMarkersToMap();
                }
            };
            
            // Fetch locations data from API
            async function fetchData() {
                try {
                    // First load ZIP to county mapping
                    const zipMapLoaded = await loadZipToCountyMap();
                    if (!zipMapLoaded) {
                        console.warn("ZIP to county mapping failed to load. County filtering may not work correctly.");
                    }
                    
                    // Show loading indicator
                    loadingIndicator.style.display = 'flex';
                    
                    // Fetch from real API
                    const response = await fetch('https://api.nycancer.com/open/directory/locations/all');
                    if (!response.ok) {
                        throw new Error(`API responded with status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Store original locations
                    allLocations = data.data;
                    
                    // Combine locations with the same address and filter to only include
                    // locations with allowed specialties
                    combinedLocations = combineLocations(allLocations);
                    
                    console.log(`Filtered to ${combinedLocations.length} locations with Medical Oncology, Radiation Oncology, or Breast Care`);
                    
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    // Now populate county filters based on actual location data
                    populateCountyFilters();
                    
                    // Update results
                    updateResults();
                    
                    // Initialize map markers if map is loaded
                    if (map) {
                        addMarkersToMap();
                    }
                    
                    // Update filter availability based on data
                    updateCountyFilterAvailability();
                    updateSpecialtyFilterAvailability();
                    
                } catch (error) {
                    console.error("Error fetching locations data:", error);
                    loadingIndicator.style.display = 'none';
                    
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-6 text-center';
                    errorDiv.style.marginBottom = '24px';
                    errorDiv.innerHTML = `
                        <div style="color: #ef4444; margin-bottom: 8px; font-size: 18px;">⚠️ Unable to load locations data: ${error.message}</div>
                        <p style="margin-bottom: 16px;">Please check your API connection and try again.</p>
                        <button
                            style="background-color: #2563eb; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;"
                            onclick="window.location.reload()"
                        >
                            Try Again
                        </button>
                    `;
                    document.querySelector('.directory-container').appendChild(errorDiv);
                }
            }
            
            // Initialize
            fetchData();
        });
    </script>
</body>
</html>

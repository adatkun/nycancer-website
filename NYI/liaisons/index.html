<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liaison Activity Story Map</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
  <style>
    :root{--slate:#313743;--accent:#0074b8;--accent-light:#e8f4fc;--accent-dark:#005a8e;--border:#e2e5e9;--text:#333;--text-light:#777;--bg:#f0f2f5;--green:#16a34a;--red:#dc2626;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
    .app{display:flex;flex-direction:column;height:100vh;}

    .topbar{background:var(--slate);color:#fff;padding:0 20px;display:flex;align-items:center;height:50px;flex-shrink:0;gap:12px;}
    .topbar-brand{display:flex;align-items:center;gap:9px;font-size:15px;font-weight:600;white-space:nowrap;}
    .topbar-brand i{color:#00B4D8;font-size:16px;}
    .tb-div{width:1px;height:24px;background:rgba(255,255,255,.15);}
    .tb-label{font-size:10px;color:rgba(255,255,255,.5);font-weight:500;text-transform:uppercase;letter-spacing:.5px;}
    .tb-select{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:5px 26px 5px 10px;border-radius:5px;font-size:12px;font-family:inherit;cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;}
    .tb-select option{background:var(--slate);color:#fff;}
    .tb-badge{background:rgba(0,180,216,.2);color:#00B4D8;padding:3px 10px;border-radius:5px;font-size:11px;font-weight:600;white-space:nowrap;}
    .tb-toggle{background:none;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.55);padding:6px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;display:flex;align-items:center;gap:6px;white-space:nowrap;}
    .tb-toggle:hover{color:#fff;background:rgba(255,255,255,.06);}
    .tb-toggle.active{background:rgba(239,68,68,.2);color:#f87171;border-color:rgba(239,68,68,.3);}
    .tb-toggle.active-blue{background:rgba(0,116,184,.25);color:#60a5fa;border-color:rgba(0,116,184,.4);}
    .tb-toggle i{font-size:11px;}
    .tb-sliders{display:flex;gap:12px;align-items:center;}
    .tb-sliders input[type=range]{-webkit-appearance:none;width:50px;height:3px;border-radius:2px;background:rgba(255,255,255,.2);outline:none;}

    .main{display:flex;flex:1;overflow:hidden;}

    .sidebar{background:#fff;display:flex;flex-direction:column;flex-shrink:0;min-width:260px;max-width:50vw;border-right:1px solid var(--border);overflow:hidden;}
    .sb-filters{padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0;}
    .sb-filters h3{font-size:13px;color:var(--slate);margin-bottom:10px;display:flex;align-items:center;gap:6px;}
    .sb-filters h3 i{color:var(--accent);font-size:11px;}

    .ac-wrap{position:relative;margin-bottom:8px;}
    .ac-input{width:100%;padding:7px 10px 7px 30px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit;outline:none;transition:border-color .15s;}
    .ac-input:focus{border-color:var(--accent);}
    .ac-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:11px;color:#bbb;pointer-events:none;}
    .ac-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:13px;color:#bbb;cursor:pointer;padding:2px;display:none;}
    .ac-clear:hover{color:var(--red);}
    .ac-input.has-value~.ac-clear{display:block;}
    .ac-input.has-value{background:var(--accent-light);border-color:var(--accent);padding-right:28px;}
    .ac-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:0 0 8px 8px;max-height:220px;overflow-y:auto;z-index:100;display:none;box-shadow:0 6px 16px rgba(0,0,0,.1);}
    .ac-dropdown.open{display:block;}
    .ac-item{padding:7px 12px;font-size:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background .08s;}
    .ac-item:hover,.ac-item.highlighted{background:var(--accent-light);}
    .ac-item-name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-right:8px;}
    .ac-item-ct{font-size:10px;font-weight:700;color:var(--accent);flex-shrink:0;}
    .ac-empty{padding:12px;font-size:11px;color:var(--text-light);text-align:center;}

    .reset-btn{width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;background:#fff;font-size:11px;font-weight:600;color:var(--text-light);cursor:pointer;font-family:inherit;transition:all .12s;display:none;align-items:center;justify-content:center;gap:5px;}
    .reset-btn:hover{border-color:var(--accent);color:var(--accent);}
    .reset-btn.visible{display:flex;}

    .sb-body{flex:1;overflow-y:auto;padding:12px 16px;}
    .stat-block{margin-bottom:16px;}
    .stat-block-title{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--text-light);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:5px;}
    .stat-block-title i{font-size:10px;color:var(--accent);}
    .stat-big{font-size:32px;font-weight:800;color:var(--slate);line-height:1;}
    .stat-sub{font-size:11px;color:var(--text-light);margin-top:2px;}
    .stat-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f5f5f5;}
    .stat-row:last-child{border-bottom:none;}
    .stat-row-name{font-size:12px;color:var(--slate);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .stat-row-val{font-size:12px;font-weight:700;color:var(--accent);flex-shrink:0;margin-left:8px;}
    .stat-row-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-right:8px;}
    .stat-row.clickable{cursor:pointer;border-radius:4px;padding:6px 4px;margin:0 -4px;}
    .stat-row.clickable:hover{background:var(--accent-light);}

    /* Location sidebar */
    .loc-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
    .loc-back{background:none;border:none;font-size:13px;color:var(--accent);cursor:pointer;padding:4px;border-radius:4px;flex-shrink:0;}
    .loc-back:hover{background:var(--accent-light);}
    .loc-title{font-size:14px;font-weight:700;color:var(--slate);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .loc-count{font-size:11px;color:var(--text-light);flex-shrink:0;}
    .loc-addr{font-size:11px;color:var(--text-light);display:flex;align-items:flex-start;gap:5px;margin-bottom:14px;padding-left:28px;}
    .loc-addr i{margin-top:2px;color:var(--accent);flex-shrink:0;font-size:10px;}

    /* Popup */
    .leaflet-popup-content-wrapper{border-radius:10px!important;box-shadow:0 4px 20px rgba(0,0,0,.15)!important;padding:0!important;}
    .leaflet-popup-content{margin:0!important;min-width:280px;max-width:360px;}
    .popup-inner{padding:14px 16px;}
    .popup-aff{font-size:15px;font-weight:700;color:var(--slate);margin-bottom:2px;}
    .popup-addr{font-size:11px;color:var(--text-light);margin-bottom:10px;display:flex;align-items:flex-start;gap:5px;}
    .popup-addr i{margin-top:2px;color:var(--accent);flex-shrink:0;font-size:10px;}
    .popup-liaisons{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
    .popup-liaison-tag{font-size:10px;font-weight:600;padding:3px 8px;border-radius:10px;}
    .popup-divider{height:1px;background:var(--border);margin:10px 0;}
    .popup-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .popup-nav-label{font-size:11px;color:var(--text-light);}
    .popup-nav-label strong{color:var(--slate);}
    .popup-nav-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:#fff;color:var(--text);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
    .popup-nav-btn:hover:not(:disabled){background:var(--accent);color:#fff;border-color:var(--accent);}
    .popup-nav-btn:disabled{opacity:.2;cursor:default;}
    .popup-visit-date{font-size:12px;font-weight:600;color:var(--slate);margin-bottom:4px;}
    .popup-visit-liaison{font-size:10px;font-weight:600;display:inline-block;padding:2px 8px;border-radius:10px;margin-bottom:6px;}
    .popup-visit-row{font-size:12px;color:#555;display:flex;align-items:flex-start;gap:6px;margin-bottom:4px;}
    .popup-visit-row i{font-size:9px;color:var(--accent);margin-top:4px;flex-shrink:0;}
    .popup-notes{font-size:11px;line-height:1.6;color:#444;background:#f8f9fb;padding:10px 12px;border-radius:6px;border-left:3px solid var(--accent);margin-top:8px;max-height:120px;overflow-y:auto;}

    /* Legend */
    .map-legend{position:absolute;bottom:16px;right:16px;background:rgba(255,255,255,.95);border:1px solid var(--border);border-radius:8px;padding:10px 14px;z-index:800;box-shadow:0 2px 8px rgba(0,0,0,.1);max-height:200px;overflow-y:auto;min-width:120px;}
    .map-legend-title{font-size:9px;text-transform:uppercase;letter-spacing:.7px;color:var(--text-light);font-weight:700;margin-bottom:6px;}
    .map-legend-item{display:flex;align-items:center;gap:7px;padding:2px 0;font-size:11px;color:var(--slate);}
    .map-legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;border:1.5px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.1);}

    .resizer{width:5px;cursor:col-resize;background:#e8e8e8;flex-shrink:0;position:relative;transition:background .12s;z-index:5;}
    .resizer:hover,.resizer.active{background:var(--accent);}

    .map-col{flex:1;display:flex;flex-direction:column;min-width:200px;}
    .map-area{flex:1;position:relative;}
    #map{width:100%;height:100%;}

    .tl-resizer{height:5px;cursor:row-resize;background:#e8e8e8;flex-shrink:0;position:relative;transition:background .12s;z-index:501;}
    .tl-resizer:hover,.tl-resizer.active{background:var(--accent);}
    .tl-resizer::after{content:'';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:32px;height:2px;background:rgba(0,0,0,.15);border-radius:1px;}

    .timeline{background:#fff;flex-shrink:0;user-select:none;z-index:500;display:flex;flex-direction:column;overflow:hidden;}
    .tl-bar-area{position:relative;flex:1;padding:8px 16px 0;overflow:visible;display:flex;flex-direction:column;justify-content:flex-end;min-height:60px;}
    .tl-bars{display:flex;align-items:flex-end;height:60px;gap:1px;position:relative;flex-shrink:0;}
    .tl-bar-wrap{flex:1;min-width:0;height:100%;display:flex;flex-direction:column;justify-content:flex-end;cursor:pointer;position:relative;}
    .tl-bar{width:100%;border-radius:2px 2px 0 0;transition:background .1s,outline .1s;min-height:1px;}
    .tl-bar-wrap:hover .tl-bar{filter:brightness(1.15);}
    .tl-bar-wrap.empty{cursor:default;}
    .tl-bar-wrap.week-highlight .tl-bar{outline:2px solid #facc15;outline-offset:-1px;border-radius:2px;box-shadow:0 0 6px rgba(250,204,21,.5);}
    .tl-selector{position:absolute;top:-20%;bottom:0;background:rgba(0,116,184,.1);border-left:3px solid var(--accent);border-right:3px solid var(--accent);border-radius:4px;z-index:10;cursor:grab;transition:left .08s,width .08s;}
    .tl-selector:active{cursor:grabbing;}
    .tl-selector .tl-sel-edge{position:absolute;top:0;bottom:0;width:10px;cursor:col-resize;z-index:2;}
    .tl-selector .tl-sel-edge.left{left:-5px;}
    .tl-selector .tl-sel-edge.right{right:-5px;}
    .tl-selector .tl-sel-label{position:absolute;top:-1px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;padding:2px 8px;border-radius:0 0 5px 5px;font-size:9px;font-weight:600;white-space:nowrap;pointer-events:none;}
    .tl-tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--slate);color:#fff;padding:6px 12px;border-radius:6px;font-size:11px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .12s;margin-bottom:6px;z-index:20;line-height:1.5;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.2);}
    .tl-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:var(--slate);}
    .tl-bar-wrap:hover .tl-tooltip{opacity:1;}
    .tl-labels{display:flex;padding:0 16px;height:18px;align-items:center;border-top:1px solid #f0f0f0;}
    .tl-month-label{font-size:9px;color:#aaa;font-weight:500;text-align:center;flex:1;min-width:0;white-space:nowrap;overflow:hidden;}
    .tl-presets{display:flex;align-items:center;gap:4px;padding:4px 16px 8px;flex-shrink:0;}
    .tl-presets-label{font-size:9px;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-right:4px;}
    .tl-preset-btn{background:#f0f2f5;border:1px solid var(--border);color:var(--text-light);padding:3px 10px;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .1s;}
    .tl-preset-btn:hover{border-color:var(--accent);color:var(--accent);}
    .tl-preset-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}

    .loading-overlay{position:fixed;inset:0;background:rgba(240,242,245,.95);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .3s;}
    .loading-overlay.hidden{opacity:0;pointer-events:none;}
    .loading-spinner{width:36px;height:36px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .loading-text{margin-top:14px;font-size:14px;color:var(--text-light);font-weight:500;}
    .loading-sub{font-size:12px;color:#aaa;margin-top:4px;}
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:.4;}50%{transform:translate(-50%,-50%) scale(1.8);opacity:0;}}

    .dot-tooltip{background:var(--slate);color:#fff;padding:5px 10px;border-radius:5px;font-size:11px;font-weight:600;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,.2);}
    .dot-tooltip .dt-count{font-weight:400;opacity:.7;margin-left:4px;}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="topbar-brand"><i class="fas fa-route"></i> Liaison Story Map</div>
    <div class="tb-div"></div>
    <div style="display:flex;align-items:center;gap:6px;">
      <label class="tb-label">Liaison</label>
      <select class="tb-select" id="liaisonSelect" style="min-width:160px;"></select>
    </div>
    <div class="tb-div"></div>
    <button class="tb-toggle" id="heatToggle"><i class="fas fa-fire"></i> Heat Overlay</button>
    <button class="tb-toggle" id="heatOnlyToggle"><i class="fas fa-eye-slash"></i> Heat Only</button>
    <div class="tb-badge" id="visitBadge">—</div>
    <div style="margin-left:auto;" class="tb-sliders" id="heatSliders">
      <div style="display:flex;align-items:center;gap:5px;">
        <label class="tb-label">Radius</label>
        <input type="range" id="heatRadiusSlider" min="10" max="50" value="28">
      </div>
      <div style="display:flex;align-items:center;gap:5px;">
        <label class="tb-label">Intensity</label>
        <input type="range" id="heatIntensitySlider" min="10" max="100" value="30">
      </div>
    </div>
  </div>
  <div class="main">
    <div class="sidebar" id="sidebar" style="width:320px;">
      <div class="sb-filters">
        <h3><i class="fas fa-filter"></i> Filter & Explore</h3>
        <div class="ac-wrap">
          <i class="fas fa-building ac-icon"></i>
          <input class="ac-input" id="practiceInput" placeholder="Search practices…" autocomplete="off">
          <button class="ac-clear" id="practiceClear"><i class="fas fa-times"></i></button>
          <div class="ac-dropdown" id="practiceDropdown"></div>
        </div>
        <div class="ac-wrap">
          <i class="fas fa-user-md ac-icon"></i>
          <input class="ac-input" id="contactInput" placeholder="Search contacts…" autocomplete="off">
          <button class="ac-clear" id="contactClear"><i class="fas fa-times"></i></button>
          <div class="ac-dropdown" id="contactDropdown"></div>
        </div>
        <button class="reset-btn" id="resetBtn"><i class="fas fa-undo"></i> Reset to Default View</button>
      </div>
      <div class="sb-body" id="sbBody"></div>
    </div>
    <div class="resizer" id="resizer"></div>
    <div class="map-col">
      <div class="map-area">
        <div id="map"></div>
        <div class="map-legend" id="mapLegend"></div>
      </div>
      <div class="tl-resizer" id="tlResizer"></div>
      <div class="timeline" id="timeline" style="height:165px;">
        <div class="tl-bar-area" id="tlBarArea">
          <div class="tl-bars" id="tlBars">
            <div class="tl-selector" id="tlSelector" style="display:none;">
              <div class="tl-sel-edge left" data-edge="left"></div>
              <div class="tl-sel-edge right" data-edge="right"></div>
              <div class="tl-sel-label" id="tlSelLabel"></div>
            </div>
          </div>
        </div>
        <div class="tl-labels" id="tlLabels"></div>
        <div class="tl-presets">
          <span class="tl-presets-label">Range:</span>
          <button class="tl-preset-btn" data-size="1">W</button>
          <button class="tl-preset-btn" data-size="4">M</button>
          <button class="tl-preset-btn" data-size="13">Q</button>
          <button class="tl-preset-btn active" data-size="all">All</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">Loading…</div>
  <div class="loading-sub" id="loadingSub">Fetching CSV</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
// ===================== STATE =====================
let allVisits=[], activeLiaison='All', weeks=[];
let selStart=0, selEnd=0, selSize='all';
let heatRadius=28, heatIntensity=0.3;
let showHeatmap=false, heatOnly=false;
let activeFilter={practice:null,contact:null};
let selectedLocation=null, selectedVisitIdx=0, activePopup=null;
const FIT_PAD=[40,50,120,50];
const DEFAULT_CENTER=[40.82,-73.2];
const DEFAULT_ZOOM=9;
const dotSize=10;
function resetMapView(){map.setView(DEFAULT_CENTER,DEFAULT_ZOOM);}

// ===================== MAP =====================
const map=L.map('map',{zoomControl:true}).setView(DEFAULT_CENTER,DEFAULT_ZOOM);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap © CARTO',maxZoom:19}).addTo(map);
let heatLayer=null;
let dotLayer=L.layerGroup().addTo(map);

// ===================== COLORS =====================
const liaisonColors={};
const pal=['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#db2777','#0891b2','#4f46e5','#ca8a04','#059669','#6366f1','#e11d48','#0d9488','#b45309','#8b5cf6'];
let ci=0;
function getColor(n){if(!liaisonColors[n])liaisonColors[n]=pal[ci++%pal.length];return liaisonColors[n];}

// ===================== FORMATTERS =====================
const fmtLong=d=>d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
const fmtShort=d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
const fmtDay=d=>d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});
const fmtDayShort=d=>d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
const fmtMonthYear=d=>d.toLocaleDateString('en-US',{month:'short',year:'2-digit'});
function fmtISO(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function getMonday(d){const dt=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=dt.getDay();dt.setDate(dt.getDate()-(day===0?6:day-1));return dt;}
function addDays(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r;}

// ===================== CSV LOADING =====================
function parseRow(row){
  const g=keys=>{for(const k of keys){const v=row[k];if(v!==undefined&&v!==null&&String(v).trim())return String(v).trim();}return '';};
  const d=new Date(g(['Date']));if(isNaN(d))return null;
  const lat=parseFloat(g(['Latitude','Lat'])),lng=parseFloat(g(['Longitude','Lng','Long']));
  if(isNaN(lat)||isNaN(lng)||lat===0||lng===0)return null;
  return{date:d,liaison:g(['Assigned','Liaison'])||'Unknown',
    affiliation:g(['Company / Account','Company/Account','Affiliation','Account'])||'Unknown',
    contact:g(['Contact','Doctor(s) Visited'])||'',specialty:g(['Specialty'])||'',
    visitType:g(['Subject','Visit Type'])||'Visit',
    internalProvider:g(['Internal Provider','Our Attending Doctors'])||'',
    status:g(['Status'])||'',overview:g(['Full Comments','Overview','Comments'])||'',
    address:g(['Corrected Address','Full Address','Address'])||g(['Mailing Address']),lat,lng};
}
async function loadCSV(){
  const el=document.getElementById('loadingText'),sub=document.getElementById('loadingSub');
  try{
    const resp=await fetch('data.csv');if(!resp.ok)throw new Error('CSV not found ('+resp.status+')');
    sub.textContent='Parsing…';const text=await resp.text();
    const result=Papa.parse(text,{header:true,skipEmptyLines:true,dynamicTyping:false,delimitersToGuess:[',','\t','|',';']});
    for(const row of result.data){const v=parseRow(row);if(v)allVisits.push(v);}
    allVisits.sort((a,b)=>a.date-b.date);
    const groups={};
    for(const v of allVisits){
      const k=fmtISO(v.date)+'|'+v.liaison+'|'+v.address.toLowerCase().replace(/\s+/g,' ');
      if(!groups[k])groups[k]={...v,_c:[],_s:[],_p:[],_o:[]};
      const g=groups[k];
      if(v.contact)g._c.push(v.contact);if(v.specialty)g._s.push(v.specialty);
      if(v.internalProvider)g._p.push(v.internalProvider);if(v.overview)g._o.push(v.overview);
    }
    const uniq=arr=>[...new Set(arr.map(s=>s.trim()).filter(Boolean))];
    allVisits=Object.values(groups).map(g=>{
      g.contact=uniq(g._c).join('; ');g.specialty=uniq(g._s).join('; ');
      g.internalProvider=uniq(g._p).join('; ');g.overview=uniq(g._o).join(' · ');
      delete g._c;delete g._s;delete g._p;delete g._o;return g;
    }).sort((a,b)=>a.date-b.date);
    [...new Set(allVisits.map(v=>v.liaison))].sort().forEach(n=>getColor(n));
    sub.textContent=allVisits.length.toLocaleString()+' visits loaded';
    setTimeout(()=>{document.getElementById('loadingOverlay').classList.add('hidden');initApp();},300);
  }catch(err){el.textContent='Error';sub.textContent=err.message;}
}

// ===================== FILTERING =====================
function getLiaisonBase(){return activeLiaison==='All'?allVisits:allVisits.filter(v=>v.liaison===activeLiaison);}
function getFilteredVisits(){
  let b=getLiaisonBase();
  if(activeFilter.practice)b=b.filter(v=>v.affiliation===activeFilter.practice);
  if(activeFilter.contact)b=b.filter(v=>v.contact&&v.contact.split(';').map(s=>s.trim()).includes(activeFilter.contact));
  return b;
}
function getVisibleVisits(){
  let v=[];for(let i=selStart;i<=selEnd&&i<weeks.length;i++)v=v.concat(weeks[i].visits);return v;
}
function getAvailablePractices(){
  let b=getLiaisonBase();
  if(weeks.length){const s=weeks[selStart]?.start,e=weeks[Math.min(selEnd,weeks.length-1)]?.end;if(s&&e)b=b.filter(v=>v.date>=s&&v.date<=e);}
  if(activeFilter.contact)b=b.filter(v=>v.contact&&v.contact.split(';').map(s=>s.trim()).includes(activeFilter.contact));
  const ct={};b.forEach(v=>ct[v.affiliation]=(ct[v.affiliation]||0)+1);return Object.entries(ct).sort((a,b)=>b[1]-a[1]);
}
function getAvailableContacts(){
  let b=getLiaisonBase();
  if(weeks.length){const s=weeks[selStart]?.start,e=weeks[Math.min(selEnd,weeks.length-1)]?.end;if(s&&e)b=b.filter(v=>v.date>=s&&v.date<=e);}
  if(activeFilter.practice)b=b.filter(v=>v.affiliation===activeFilter.practice);
  const ct={};b.forEach(v=>{if(!v.contact)return;v.contact.split(';').map(s=>s.trim()).filter(Boolean).forEach(c=>ct[c]=(ct[c]||0)+1);});
  return Object.entries(ct).sort((a,b)=>b[1]-a[1]);
}

// ===================== WEEK BUCKETS =====================
function buildWeeks(){
  const base=getFilteredVisits();
  const rangeStart=new Date(2025,5,1),rangeEnd=new Date();
  let mon=getMonday(rangeStart);weeks=[];
  while(mon<=rangeEnd){
    const sun=addDays(mon,6);const wv=base.filter(v=>v.date>=mon&&v.date<=sun);
    weeks.push({start:new Date(mon),end:sun,visits:wv,count:wv.length});mon=addDays(mon,7);
  }
  if(selSize==='all'){selStart=0;selEnd=weeks.length-1;}
  else{
    const last=weeks.reduce((b,w,i)=>w.count>0?i:b,weeks.length-1);
    selEnd=Math.min(last,weeks.length-1);selStart=Math.max(0,selEnd-selSize+1);
  }
  document.getElementById('visitBadge').textContent=base.length.toLocaleString()+' filtered';
}

// ===================== TIMELINE =====================
function renderTimeline(){
  const barsEl=document.getElementById('tlBars'),labelsEl=document.getElementById('tlLabels'),sel=document.getElementById('tlSelector');
  barsEl.querySelectorAll('.tl-bar-wrap').forEach(el=>el.remove());labelsEl.innerHTML='';
  if(!weeks.length)return;

  // If a location is selected, compute per-week counts for just that location
  let locWeekCounts=null;
  if(selectedLocation){
    const locKey=selectedLocation.key;
    locWeekCounts=weeks.map(w=>{
      return w.visits.filter(v=>{
        if(!v.lat||!v.lng)return false;
        return(v.lat.toFixed(4)+','+v.lng.toFixed(4))===locKey;
      }).length;
    });
  }

  const counts=locWeekCounts||weeks.map(w=>w.count);
  const maxCount=Math.max(...counts,1);
  let curMonth=-1;const monthSpans=[];let spanStart=0;
  weeks.forEach((w,i)=>{
    const m=w.start.getMonth();
    if(m!==curMonth){if(curMonth!==-1)monthSpans.push({month:curMonth,year:weeks[spanStart].start.getFullYear(),start:spanStart,end:i-1});curMonth=m;spanStart=i;}
    const ct=counts[i];
    const pct=ct>0?Math.max(4,(ct/maxCount)*100):0;
    const color=ct===0?'transparent':barColor(ct,maxCount);
    const wrap=document.createElement('div');wrap.className='tl-bar-wrap'+(ct===0?' empty':'');wrap.dataset.idx=i;
    const bar=document.createElement('div');bar.className='tl-bar';bar.style.height=pct+'%';bar.style.background=color;wrap.appendChild(bar);
    if(ct>0){
      const tip=document.createElement('div');tip.className='tl-tooltip';
      tip.innerHTML=`<strong>${fmtShort(w.start)} – ${fmtShort(w.end)}</strong><br>${ct} visit${ct!==1?'s':''}`;
      wrap.appendChild(tip);
      wrap.addEventListener('click',e=>{e.stopPropagation();selSize=1;updatePresetButtons();moveSelector(i,i);});
    }
    barsEl.insertBefore(wrap,sel);
  });
  monthSpans.push({month:curMonth,year:weeks[spanStart].start.getFullYear(),start:spanStart,end:weeks.length-1});
  monthSpans.forEach(ms=>{const span=document.createElement('div');span.className='tl-month-label';span.style.flex=(ms.end-ms.start+1);span.textContent=fmtMonthYear(new Date(ms.year,ms.month,1));labelsEl.appendChild(span);});
  renderSelector();
  highlightTimelineWeek();
}
function barColor(c,max){const t=c/max;if(t<.2)return'#93c5fd';if(t<.4)return'#60a5fa';if(t<.6)return'#3b82f6';if(t<.8)return'#2563eb';return'#1d4ed8';}

function highlightTimelineWeek(){
  document.querySelectorAll('.tl-bar-wrap.week-highlight').forEach(el=>el.classList.remove('week-highlight'));
  if(!selectedLocation)return;
  const v=selectedLocation.visits[selectedVisitIdx];
  if(!v)return;
  const vDate=v.date;
  for(let i=0;i<weeks.length;i++){
    if(vDate>=weeks[i].start&&vDate<=weeks[i].end){
      const wrap=document.querySelector(`.tl-bar-wrap[data-idx="${i}"]`);
      if(wrap)wrap.classList.add('week-highlight');
      break;
    }
  }
}
function updatePresetButtons(){document.querySelectorAll('.tl-preset-btn').forEach(b=>{const s=b.dataset.size;b.classList.toggle('active',s==='all'?selSize==='all':parseInt(s)===selSize);});}
function selectorLabel(){if(!weeks.length)return'';if(selSize==='all')return'All Time';if(selStart===selEnd)return fmtShort(weeks[selStart].start)+' – '+fmtShort(weeks[selStart].end);return fmtShort(weeks[selStart].start)+' – '+fmtShort(weeks[selEnd].end);}

function moveSelector(ns,ne){
  ns=Math.max(0,ns);ne=Math.min(weeks.length-1,ne);if(ns>ne)return;
  selStart=ns;selEnd=ne;renderSelector();renderMap();renderSidebar();
}
function renderSelector(){
  const sel=document.getElementById('tlSelector'),barsEl=document.getElementById('tlBars');
  if(!weeks.length){sel.style.display='none';return;}
  if(selSize==='all'){sel.style.display='none';const lbl=document.getElementById('tlSelLabel');return;}
  sel.style.display='block';
  const barWraps=barsEl.querySelectorAll('.tl-bar-wrap');if(!barWraps.length)return;
  const barsRect=barsEl.getBoundingClientRect();
  const startRect=barWraps[selStart].getBoundingClientRect();
  const endRect=barWraps[Math.min(selEnd,barWraps.length-1)].getBoundingClientRect();
  sel.style.left=(startRect.left-barsRect.left)+'px';sel.style.width=(endRect.right-startRect.left)+'px';sel.style.transition='none';
  const lbl=document.getElementById('tlSelLabel');const sv=getVisibleVisits();
  lbl.textContent=sv.length+' visit'+(sv.length!==1?'s':'')+' · '+selectorLabel();
}

// Selector drag
(function(){
  const sel=document.getElementById('tlSelector');let dragType=null,dragStartX=0,origS=0,origE=0;
  function bw(){const w=document.getElementById('tlBars').querySelectorAll('.tl-bar-wrap');if(w.length<2)return document.getElementById('tlBars').offsetWidth/(weeks.length||1);return w[1].getBoundingClientRect().left-w[0].getBoundingClientRect().left;}
  sel.addEventListener('mousedown',e=>{if(selSize==='all')return;dragType=e.target.dataset.edge||'move';dragStartX=e.clientX;origS=selStart;origE=selEnd;e.preventDefault();document.body.style.cursor=dragType==='move'?'grabbing':'col-resize';document.body.style.userSelect='none';});
  document.addEventListener('mousemove',e=>{if(!dragType)return;const dx=e.clientX-dragStartX,dB=Math.round(dx/bw());let ns=origS,ne=origE;if(dragType==='move'){ns=origS+dB;ne=origE+dB;}else if(dragType==='left'){ns=origS+dB;}else{ne=origE+dB;}ns=Math.max(0,Math.min(weeks.length-1,ns));ne=Math.max(ns,Math.min(weeks.length-1,ne));if(ne<ns)return;selStart=ns;selEnd=ne;selSize=selEnd-selStart+1;updatePresetButtons();renderSelector();});
  document.addEventListener('mouseup',()=>{if(!dragType)return;dragType=null;document.body.style.cursor='';document.body.style.userSelect='';renderMap();renderSidebar();});
})();

// ===================== MAP RENDERING =====================
function buildLocGroups(visits){
  const m={};visits.forEach(v=>{if(!v.lat||!v.lng)return;const k=v.lat.toFixed(4)+','+v.lng.toFixed(4);
    if(!m[k])m[k]={lat:v.lat,lng:v.lng,affs:new Set(),visits:[],count:0,key:k};
    m[k].affs.add(v.affiliation);m[k].visits.push(v);m[k].count++;});
  return Object.values(m);
}

function getDominantLiaison(visits){
  const ct={};visits.forEach(v=>ct[v.liaison]=(ct[v.liaison]||0)+1);
  let best='',max=0;for(const[n,c]of Object.entries(ct)){if(c>max){max=c;best=n;}}return best;
}

function renderMap(fitType){
  // fitType: false=no move, 'default'=go to default view, 'fit'=fitBounds to data
  clearMapLayers();
  const visits=getVisibleVisits();if(!visits.length){if(fitType)resetMapView();return;}
  const locGroups=buildLocGroups(visits);
  const isFiltered=activeFilter.practice||activeFilter.contact;

  // Faded context dots when filtered
  if(isFiltered){
    const start=weeks[selStart]?.start,end=weeks[selEnd]?.end;
    if(start&&end){
      const bg=getLiaisonBase().filter(v=>v.date>=start&&v.date<=end);
      const allLG=buildLocGroups(bg);
      allLG.forEach(loc=>{if(locGroups.find(l=>l.key===loc.key))return;
        const sz=Math.max(6,dotSize-2);
        L.marker([loc.lat,loc.lng],{icon:L.divIcon({className:'',html:`<div style="width:${sz}px;height:${sz}px;background:#ccc;border:1px solid #fff;border-radius:50%;opacity:.35;"></div>`,iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]}),interactive:false}).addTo(dotLayer);
      });
    }
  }

  // Active dots
  if(!heatOnly){
    const bounds=[];
    locGroups.forEach(loc=>{
      const dominant=getDominantLiaison(loc.visits);
      const color=getColor(dominant);
      const sz=Math.min(dotSize+Math.floor(loc.count/3),dotSize+8);
      const icon=L.divIcon({className:'',
        html:`<div style="width:${sz}px;height:${sz}px;background:${color};border:2px solid #fff;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,.3);cursor:pointer;transition:transform .1s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'"></div>`,
        iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
      const marker=L.marker([loc.lat,loc.lng],{icon}).addTo(dotLayer);
      const affList=[...loc.affs];const affText=affList.length<=2?affList.join(' / '):affList[0]+` +${affList.length-1}`;
      marker.bindTooltip(`<div class="dot-tooltip">${affText}<span class="dt-count">(${loc.count})</span></div>`,{direction:'top',offset:[0,-sz/2-4],className:'',permanent:false});
      marker.on('click',()=>openLocationPopup(loc));
      bounds.push([loc.lat,loc.lng]);
    });
    if(fitType==='default')resetMapView();
    else if(fitType==='fit'&&bounds.length>1)map.fitBounds(bounds,{padding:FIT_PAD,maxZoom:13});
    else if(fitType==='fit'&&bounds.length===1)map.setView(bounds[0],12);
  }

  // Heatmap
  if(showHeatmap||heatOnly)renderHeatLayer(locGroups);
  if(heatOnly&&fitType){
    if(fitType==='default')resetMapView();
    else if(locGroups.length>1)map.fitBounds(locGroups.map(l=>[l.lat,l.lng]),{padding:FIT_PAD,maxZoom:13});
    else if(locGroups.length===1)map.setView([locGroups[0].lat,locGroups[0].lng],12);
  }

  renderLegend();
}

function renderHeatLayer(locGroups){
  if(heatLayer){map.removeLayer(heatLayer);heatLayer=null;}
  if(!locGroups){locGroups=buildLocGroups(getVisibleVisits());}
  if(!locGroups.length)return;
  const maxC=Math.max(...locGroups.map(l=>l.count),1);
  const pts=locGroups.map(l=>[l.lat,l.lng,l.count/maxC]);
  heatLayer=L.heatLayer(pts,{radius:heatRadius,blur:Math.round(heatRadius*.8),maxZoom:13,max:1.0,minOpacity:heatIntensity,
    gradient:{0.0:'#3b82f6',0.25:'#06b6d4',0.5:'#22c55e',0.7:'#facc15',0.85:'#f97316',1.0:'#ef4444'}}).addTo(map);
}

function clearMapLayers(){
  if(heatLayer){map.removeLayer(heatLayer);heatLayer=null;}
  dotLayer.clearLayers();
  if(activePopup){map.closePopup(activePopup);activePopup=null;}
}

// ===================== LEGEND =====================
function renderLegend(){
  const el=document.getElementById('mapLegend');
  if(heatOnly){el.innerHTML='';el.style.display='none';return;}
  const visits=getVisibleVisits();
  const liaisons=new Set(visits.map(v=>v.liaison));
  if(liaisons.size===0){el.style.display='none';return;}
  el.style.display='block';
  let html='<div class="map-legend-title">Liaisons</div>';
  [...liaisons].sort().forEach(name=>{
    html+=`<div class="map-legend-item"><div class="map-legend-dot" style="background:${getColor(name)};"></div>${name}</div>`;
  });
  el.innerHTML=html;
}

// ===================== POPUP =====================
function openLocationPopup(loc){
  selectedLocation={...loc,visits:[...loc.visits].sort((a,b)=>a.date-b.date)};
  selectedVisitIdx=0;
  if(activePopup)map.closePopup(activePopup);
  const popup=L.popup({maxWidth:380,minWidth:280,closeButton:true,autoPan:true,autoPanPadding:[60,60],keepInView:true})
    .setLatLng([loc.lat,loc.lng]).setContent(buildPopupHTML()).openOn(map);
  activePopup=popup;
  popup.on('remove',()=>{activePopup=null;selectedLocation=null;renderTimeline();renderSidebar();});
  renderTimeline();
  highlightTimelineWeek();
  renderSidebar();
}

function buildPopupHTML(){
  const loc=selectedLocation,v=loc.visits[selectedVisitIdx],total=loc.visits.length;
  const affList=[...loc.affs];const affText=affList.length<=2?affList.join(' / '):affList[0]+` +${affList.length-1}`;
  const lCounts={};loc.visits.forEach(vi=>lCounts[vi.liaison]=(lCounts[vi.liaison]||0)+1);
  const liaisonTags=Object.entries(lCounts).sort((a,b)=>b[1]-a[1]).map(([name,ct])=>{const c=getColor(name);return`<span class="popup-liaison-tag" style="background:${c}18;color:${c};">${name} (${ct})</span>`;}).join('');
  const contacts=v.contact?v.contact.split(';').map(s=>s.trim()).filter(Boolean):[];
  const cStr=contacts.length<=3?contacts.join(', '):contacts.slice(0,3).join(', ')+` +${contacts.length-3}`;
  const provs=v.internalProvider?v.internalProvider.split(';').map(s=>s.trim()).filter(Boolean):[];
  const pStr=provs.length<=3?provs.join(', '):provs.slice(0,3).join(', ')+` +${provs.length-3}`;
  const lc=getColor(v.liaison);
  let h=`<div class="popup-inner"><div class="popup-aff">${affText}</div>
    <div class="popup-addr"><i class="fas fa-map-marker-alt"></i><span>${v.address||'—'}</span></div>
    <div class="popup-liaisons">${liaisonTags}</div><div class="popup-divider"></div>
    <div class="popup-nav">
      <button class="popup-nav-btn" id="popPrev" ${selectedVisitIdx<=0?'disabled':''}><i class="fas fa-chevron-left"></i></button>
      <div class="popup-nav-label">Visit <strong>${selectedVisitIdx+1}</strong> of ${total}</div>
      <button class="popup-nav-btn" id="popNext" ${selectedVisitIdx>=total-1?'disabled':''}><i class="fas fa-chevron-right"></i></button>
    </div>
    <div class="popup-visit-date">${fmtDay(v.date)}</div>
    <div class="popup-visit-liaison" style="background:${lc}18;color:${lc};">${v.liaison}</div>`;
  if(cStr)h+=`<div class="popup-visit-row"><i class="fas fa-user-md"></i><span>${cStr}</span></div>`;
  if(v.specialty)h+=`<div class="popup-visit-row"><i class="fas fa-tag"></i><span>${v.specialty}</span></div>`;
  if(pStr)h+=`<div class="popup-visit-row"><i class="fas fa-stethoscope"></i><span>${pStr}</span></div>`;
  if(v.visitType)h+=`<div class="popup-visit-row"><i class="fas fa-clipboard"></i><span>${v.visitType}${v.status?' · '+v.status:''}</span></div>`;
  if(v.overview)h+=`<div class="popup-notes">${v.overview}</div>`;
  h+=`</div>`;

  // We need to bind events after the popup content is in the DOM
  setTimeout(()=>{
    const prev=document.getElementById('popPrev'),next=document.getElementById('popNext');
    if(prev)prev.onclick=e=>{e.stopPropagation();navPopupVisit(-1);};
    if(next)next.onclick=e=>{e.stopPropagation();navPopupVisit(1);};
  },0);

  return h;
}

function navPopupVisit(dir){
  if(!selectedLocation)return;
  const ni=selectedVisitIdx+dir;
  if(ni<0||ni>=selectedLocation.visits.length)return;
  selectedVisitIdx=ni;
  if(activePopup){
    activePopup.setContent(buildPopupHTML());
    activePopup.setLatLng([selectedLocation.lat,selectedLocation.lng]);
  }
  highlightTimelineWeek();
  renderSidebar();
}

// ===================== SIDEBAR =====================
function renderSidebar(){
  const body=document.getElementById('sbBody');
  if(selectedLocation){renderLocationSidebar(body);return;}
  const visits=getVisibleVisits();
  if(!visits.length){body.innerHTML='<div style="text-align:center;padding:32px;color:var(--text-light);font-size:13px;"><i class="fas fa-inbox" style="font-size:28px;display:block;margin-bottom:10px;color:#ddd;"></i>No visits in this range.</div>';return;}
  const practices=new Set(visits.map(v=>v.affiliation)).size;
  let html=`<div class="stat-block"><div class="stat-big">${visits.length}</div><div class="stat-sub">visits across ${practices} practice${practices!==1?'s':''}</div></div>`;
  const liaisons=new Set(visits.map(v=>v.liaison));
  if(liaisons.size>1||activeLiaison==='All'){
    const lCounts={};visits.forEach(v=>lCounts[v.liaison]=(lCounts[v.liaison]||0)+1);
    html+=`<div class="stat-block"><div class="stat-block-title"><i class="fas fa-user-tie"></i> Liaisons</div>`;
    Object.entries(lCounts).sort((a,b)=>b[1]-a[1]).forEach(([name,ct])=>{
      html+=`<div class="stat-row"><div class="stat-row-dot" style="background:${getColor(name)};"></div><div class="stat-row-name">${name}</div><div class="stat-row-val">${ct}</div></div>`;
    });html+=`</div>`;
  }
  const affCounts={};visits.forEach(v=>affCounts[v.affiliation]=(affCounts[v.affiliation]||0)+1);
  html+=`<div class="stat-block"><div class="stat-block-title"><i class="fas fa-building"></i> Top Practices</div>`;
  Object.entries(affCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(([name,ct])=>{
    const esc=name.replace(/'/g,"\\'");
    html+=`<div class="stat-row clickable" onclick="selectPractice('${esc}')"><div class="stat-row-name" title="${name}">${name}</div><div class="stat-row-val">${ct}</div></div>`;
  });html+=`</div>`;
  const contactCounts={};visits.forEach(v=>{if(!v.contact)return;v.contact.split(';').map(s=>s.trim()).filter(Boolean).forEach(c=>contactCounts[c]=(contactCounts[c]||0)+1);});
  const topC=Object.entries(contactCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  if(topC.length){
    html+=`<div class="stat-block"><div class="stat-block-title"><i class="fas fa-user-md"></i> Top Contacts</div>`;
    topC.forEach(([name,ct])=>{const esc=name.replace(/'/g,"\\'");html+=`<div class="stat-row clickable" onclick="selectContact('${esc}')"><div class="stat-row-name">${name}</div><div class="stat-row-val">${ct}</div></div>`;});
    html+=`</div>`;
  }
  body.innerHTML=html;
}

function renderLocationSidebar(body){
  const loc=selectedLocation,visits=loc.visits;
  const affList=[...loc.affs];const affText=affList.length<=2?affList.join(' / '):affList[0]+` +${affList.length-1}`;
  const addr=visits[0]?.address||'—';
  let html=`<div class="loc-header">
    <button class="loc-back" onclick="closeLocation()" title="Back to overview"><i class="fas fa-arrow-left"></i></button>
    <div class="loc-title" title="${affText}">${affText}</div>
    <div class="loc-count">${visits.length} visit${visits.length!==1?'s':''}</div>
  </div>
  <div class="loc-addr"><i class="fas fa-map-marker-alt"></i><span>${addr}</span></div>`;

  // Big count
  html+=`<div class="stat-block"><div class="stat-big">${visits.length}</div><div class="stat-sub">total visits at this location</div></div>`;

  // Visits per liaison
  const lCounts={};visits.forEach(v=>lCounts[v.liaison]=(lCounts[v.liaison]||0)+1);
  html+=`<div class="stat-block"><div class="stat-block-title"><i class="fas fa-user-tie"></i> Visits by Liaison</div>`;
  Object.entries(lCounts).sort((a,b)=>b[1]-a[1]).forEach(([name,ct])=>{
    html+=`<div class="stat-row"><div class="stat-row-dot" style="background:${getColor(name)};"></div><div class="stat-row-name">${name}</div><div class="stat-row-val">${ct}</div></div>`;
  });
  html+=`</div>`;

  // Visits per contact
  const cCounts={};visits.forEach(v=>{if(!v.contact)return;v.contact.split(';').map(s=>s.trim()).filter(Boolean).forEach(c=>cCounts[c]=(cCounts[c]||0)+1);});
  const topC=Object.entries(cCounts).sort((a,b)=>b[1]-a[1]);
  if(topC.length){
    html+=`<div class="stat-block"><div class="stat-block-title"><i class="fas fa-user-md"></i> Visits by Contact</div>`;
    topC.forEach(([name,ct])=>{html+=`<div class="stat-row"><div class="stat-row-name">${name}</div><div class="stat-row-val">${ct}</div></div>`;});
    html+=`</div>`;
  }

  // Visit type breakdown
  const tCounts={};visits.forEach(v=>{const t=v.visitType||'Visit';tCounts[t]=(tCounts[t]||0)+1;});
  if(Object.keys(tCounts).length>1){
    html+=`<div class="stat-block"><div class="stat-block-title"><i class="fas fa-clipboard"></i> Visit Types</div>`;
    Object.entries(tCounts).sort((a,b)=>b[1]-a[1]).forEach(([name,ct])=>{html+=`<div class="stat-row"><div class="stat-row-name">${name}</div><div class="stat-row-val">${ct}</div></div>`;});
    html+=`</div>`;
  }

  body.innerHTML=html;
}

function closeLocation(){
  selectedLocation=null;if(activePopup){map.closePopup(activePopup);activePopup=null;}renderTimeline();renderSidebar();
}

// ===================== AUTOCOMPLETE =====================
function setupAutocomplete(inputId,clearId,dropdownId,getItems,onSelect,onClear){
  const input=document.getElementById(inputId),clearBtn=document.getElementById(clearId),dropdown=document.getElementById(dropdownId);
  let items=[],hlIdx=-1,isSelected=false;
  function render(filter){
    items=getItems();if(filter){const f=filter.toLowerCase();items=items.filter(([name])=>name.toLowerCase().includes(f));}
    if(!items.length){dropdown.innerHTML='<div class="ac-empty">No matches</div>';dropdown.classList.add('open');return;}
    hlIdx=-1;dropdown.innerHTML=items.slice(0,50).map(([name,ct],i)=>`<div class="ac-item" data-idx="${i}"><span class="ac-item-name" title="${name}">${name}</span><span class="ac-item-ct">${ct}</span></div>`).join('');
    dropdown.classList.add('open');
  }
  function close(){dropdown.classList.remove('open');hlIdx=-1;}
  function select(name){input.value=name;input.classList.add('has-value');isSelected=true;close();onSelect(name);}
  input.addEventListener('focus',()=>{if(!isSelected)render(input.value);});
  input.addEventListener('input',()=>{if(isSelected){isSelected=false;input.classList.remove('has-value');onClear();}render(input.value);});
  input.addEventListener('keydown',e=>{
    const els=dropdown.querySelectorAll('.ac-item');
    if(e.key==='ArrowDown'){e.preventDefault();hlIdx=Math.min(hlIdx+1,els.length-1);els.forEach((el,i)=>el.classList.toggle('highlighted',i===hlIdx));}
    else if(e.key==='ArrowUp'){e.preventDefault();hlIdx=Math.max(hlIdx-1,0);els.forEach((el,i)=>el.classList.toggle('highlighted',i===hlIdx));}
    else if(e.key==='Enter'&&hlIdx>=0&&hlIdx<items.length){e.preventDefault();select(items[hlIdx][0]);}
    else if(e.key==='Escape'){close();input.blur();}
  });
  dropdown.addEventListener('click',e=>{const item=e.target.closest('.ac-item');if(!item)return;const idx=parseInt(item.dataset.idx);if(idx>=0&&idx<items.length)select(items[idx][0]);});
  clearBtn.addEventListener('click',()=>{input.value='';input.classList.remove('has-value');isSelected=false;onClear();input.focus();});
  document.addEventListener('click',e=>{if(!e.target.closest('#'+inputId)&&!e.target.closest('#'+dropdownId))close();});
}
function selectPractice(name){activeFilter.practice=name;document.getElementById('practiceInput').value=name;document.getElementById('practiceInput').classList.add('has-value');applyFilters('fit');}
function selectContact(name){activeFilter.contact=name;document.getElementById('contactInput').value=name;document.getElementById('contactInput').classList.add('has-value');applyFilters('fit');}
function applyFilters(fitType){
  const has=activeFilter.practice||activeFilter.contact;
  document.getElementById('resetBtn').classList.toggle('visible',has);
  selectedLocation=null;if(activePopup){map.closePopup(activePopup);activePopup=null;}
  buildWeeks();renderTimeline();renderMap(fitType);renderSidebar();
}
function resetFilters(){
  activeFilter={practice:null,contact:null};
  document.getElementById('practiceInput').value='';document.getElementById('practiceInput').classList.remove('has-value');
  document.getElementById('contactInput').value='';document.getElementById('contactInput').classList.remove('has-value');
  applyFilters('default');
}

// ===================== TOGGLES =====================
document.getElementById('heatToggle').addEventListener('click',()=>{
  showHeatmap=!showHeatmap;
  if(showHeatmap)heatOnly=false;
  syncToggles();renderMap();
});
document.getElementById('heatOnlyToggle').addEventListener('click',()=>{
  heatOnly=!heatOnly;
  if(heatOnly)showHeatmap=false;
  syncToggles();renderMap();
});
function syncToggles(){
  document.getElementById('heatToggle').classList.toggle('active',showHeatmap);
  document.getElementById('heatOnlyToggle').classList.toggle('active-blue',heatOnly);
}
document.getElementById('heatRadiusSlider').addEventListener('input',e=>{heatRadius=parseInt(e.target.value);if(showHeatmap||heatOnly)renderHeatLayer();});
document.getElementById('heatIntensitySlider').addEventListener('input',e=>{heatIntensity=parseInt(e.target.value)/100;if(showHeatmap||heatOnly)renderHeatLayer();});

// ===================== LIAISON DROPDOWN =====================
function buildLiaisonDropdown(){
  const sel=document.getElementById('liaisonSelect');
  const ls=[...new Set(allVisits.map(v=>v.liaison))].sort();
  sel.innerHTML=`<option value="All">All Liaisons (${allVisits.length.toLocaleString()})</option>`;
  ls.forEach(l=>{const ct=allVisits.filter(v=>v.liaison===l).length;sel.innerHTML+=`<option value="${l}">${l} (${ct})</option>`;});
}
document.getElementById('liaisonSelect').addEventListener('change',e=>{activeLiaison=e.target.value;resetFilters();});

// ===================== RESIZERS =====================
(function(){const r=document.getElementById('resizer'),p=document.getElementById('sidebar');let sx,sw,d=false;
  r.addEventListener('mousedown',e=>{e.preventDefault();d=true;sx=e.clientX;sw=p.offsetWidth;r.classList.add('active');document.body.style.cursor='col-resize';document.body.style.userSelect='none';});
  document.addEventListener('mousemove',e=>{if(!d)return;p.style.width=Math.max(260,Math.min(window.innerWidth*.5,sw+(e.clientX-sx)))+'px';map.invalidateSize();});
  document.addEventListener('mouseup',()=>{if(!d)return;d=false;r.classList.remove('active');document.body.style.cursor='';document.body.style.userSelect='';map.invalidateSize();});
})();
(function(){const r=document.getElementById('tlResizer'),tl=document.getElementById('timeline');let sy,sh,d=false;
  r.addEventListener('mousedown',e=>{e.preventDefault();d=true;sy=e.clientY;sh=tl.offsetHeight;r.classList.add('active');document.body.style.cursor='row-resize';document.body.style.userSelect='none';});
  document.addEventListener('mousemove',e=>{if(!d)return;tl.style.height=Math.max(80,Math.min(window.innerHeight*.5,sh-(e.clientY-sy)))+'px';map.invalidateSize();});
  document.addEventListener('mouseup',()=>{if(!d)return;d=false;r.classList.remove('active');document.body.style.cursor='';document.body.style.userSelect='';map.invalidateSize();});
})();

// ===================== PRESETS & KEYS =====================
document.querySelectorAll('.tl-preset-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const s=btn.dataset.size;
    if(s==='all'){selSize='all';selStart=0;selEnd=weeks.length-1;updatePresetButtons();renderSelector();renderMap('default');renderSidebar();return;}
    selSize=parseInt(s);updatePresetButtons();
    const center=Math.round((selStart+selEnd)/2),half=Math.floor(selSize/2);
    let ns=center-half,ne=ns+selSize-1;
    if(ns<0){ns=0;ne=selSize-1;}if(ne>=weeks.length){ne=weeks.length-1;ns=Math.max(0,ne-selSize+1);}
    moveSelector(ns,ne);
  });
});
document.getElementById('resetBtn').addEventListener('click',resetFilters);
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;
  if(e.code==='Escape'&&selectedLocation){closeLocation();return;}
  // Arrow keys navigate popup visits when a location is open
  if(selectedLocation){
    if(e.code==='ArrowRight'||e.code==='ArrowDown'){e.preventDefault();navPopupVisit(1);}
    if(e.code==='ArrowLeft'||e.code==='ArrowUp'){e.preventDefault();navPopupVisit(-1);}
    return;
  }
  // Otherwise move timeline selector
  if(selSize==='all')return;
  if(e.code==='ArrowRight'){e.preventDefault();moveSelector(selStart+1,selEnd+1);}
  if(e.code==='ArrowLeft'){e.preventDefault();moveSelector(selStart-1,selEnd-1);}
});

// ===================== INIT =====================
function initApp(){
  buildLiaisonDropdown();
  setupAutocomplete('practiceInput','practiceClear','practiceDropdown',getAvailablePractices,name=>{activeFilter.practice=name;applyFilters('fit');},()=>{activeFilter.practice=null;applyFilters('default');});
  setupAutocomplete('contactInput','contactClear','contactDropdown',getAvailableContacts,name=>{activeFilter.contact=name;applyFilters('fit');},()=>{activeFilter.contact=null;applyFilters('default');});
  buildWeeks();renderTimeline();renderMap('default');renderSidebar();
}
loadCSV();
</script>
</body>
</html>